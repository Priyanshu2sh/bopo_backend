{% extends "bopo_admin/base.html" %}

{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'bopo_admin/css/employee_list.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="employee-container">
    <div class="employee-header">
        <h2>Employee's List</h2>
        <button class="add-employee-btn" onclick="window.location.href='{% url 'add_employee' %}'">+ Add Employee</button>
    </div>

    <div class="employee-list">
        <div class="employee-item">
            <label class="employee-label" onclick="toggleTable('corporate-table')">
                <span class="employee-icon">üè¢</span>
                <span> Employee's List</span>
            </label>
            <div class="employee-table" id="corporate-table">
                <input type="text" class="search-box" id="search-corporate" onkeyup="filterTable('corporate-table-content', 'search-corporate')" placeholder="Search corporate employees...">
                <div class="table-wrapper">
                    <table id="corporate-table-content">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Email ID</th>
                                <th>Mobile Number</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="employee-table-body">
                            {% for employee in employees %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ employee.employee_id }}</td>
                                <td>{{ employee.name }}</td>
                                <td>{{ employee.email }}</td>
                                <td>{{ employee.mobile }}</td>
                                <td>{{ employee.username }}</td>
                                <td>{{ employee.password }}</td>
                                <td>
                                    <button class="edit-btn" onclick="openEditModal('{{ employee.id }}')">‚úèÔ∏è</button>
                                    <button class="delete-btn" onclick="deleteEmployee('{{ employee.id }}')">üóëÔ∏è</button>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8">No employees found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="pagination-controls" class="pagination-controls"></div>
                </div>
            </div>

            <!-- Edit Modal -->
            <div id="editModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditModal()">&times;</span>
                    <h3>Edit Employee</h3>
                    <form id="editEmployeeForm">
                        <input type="hidden" name="employee_id" id="edit_employee_id">

                        <div class="addemployee-form-container">
                            <!-- Left Column -->
                            <div class="addemployee-form-group">
                                <label for="edit_employee_name">Employee Name</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-user"></i>
                                    <input type="text" id="edit_employee_name" name="employee_name" pattern="[A-Za-z\s]+" title="Only letters and spaces allowed" required>
                                </div>

                                <label for="edit_email">Email ID</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-envelope"></i>
                                    <input type="email" id="edit_email" name="email" required>
                                </div>

                                <label for="edit_aadhaar">Aadhaar Number</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-id-card"></i>
                                    <input type="text" id="edit_aadhaar" name="aadhaar" pattern="\d{12}" maxlength="12" required>
                                </div>

                                <label for="edit_address">Address</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <input type="text" id="edit_address" name="address" required>
                                </div>

                                <label for="edit_state">Select State</label>
                                <select id="edit_state" name="state" class="select2" onchange="fetchCities(this.value)">
                                    <option value=" ">Select State</option>
                                </select>

                                <label for="edit_city">Select City</label>
                                <select id="edit_city" name="city" class="select2" onchange="fetchCities()">
                                    <option value=" ">Select City</option>
                                </select>

                                <label for="edit_country">Country</label>
                                <div class="addemployee-input-container">
                                    <input type="text" name="country" value="India" disabled>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="addemployee-form-group">
                                <label for="edit_username">User Name</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-user"></i>
                                    <input type="text" id="edit_username" name="username" required>
                                </div>

                                <label for="edit_password">Password</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" id="edit_password" name="password" required class="password-field">
                                    <span class="password-toggle" onclick="togglePassword('edit_password')">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>

                                <label for="edit_confirmPassword">Confirm Password</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" id="edit_confirmPassword" name="confirm_password" required class="password-field">
                                    <span class="password-toggle" onclick="togglePassword('edit_confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>

                                <div id="password-error" style="display: none; margin-top: 10px;">
                                    <div style="background-color: #ffe6e6; border: 1px solid #ff4d4d; color: #d8000c; padding: 10px; border-radius: 5px; font-size: 14px; display: flex; align-items: center;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        Password and Confirm Password do not match. Please try again.
                                    </div>
                                </div>

                                <label for="edit_mobile">Mobile Number</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-mobile-alt"></i>
                                    <input type="tel" id="edit_mobile" name="mobile" pattern="\d{10}" maxlength="10" required>
                                </div>

                                <label for="edit_pan">Pan Number</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-id-card"></i>
                                    <input type="text" id="edit_pan" name="pan" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" required>
                                </div>

                                <label for="edit_pincode">Pincode</label>
                                <div class="addemployee-input-container">
                                    <i class="fas fa-home"></i>
                                    <input type="text" id="edit_pincode" name="pincode" pattern="\d{6}" maxlength="6">
                                </div>

                                <button type="submit" class="addemployee-btn-submit">Save Changes</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    fetchStates();
    paginateTable();

    $('.select2').select2({
        placeholder: "Select an option",
        allowClear: true,
        width: '100%'
    });
});

function toggleTable(tableId) {
    const tableDiv = document.getElementById(tableId);
    const isOpen = tableDiv.style.maxHeight === "500px";
    tableDiv.style.maxHeight = isOpen ? "0px" : "500px";
    tableDiv.style.padding = isOpen ? "0px" : "15px";
}

function filterTable(tableId, searchBoxId) {
    const input = document.getElementById(searchBoxId).value.toLowerCase();
    const rows = document.getElementById(tableId).getElementsByTagName("tr");
    for (let i = 1; i < rows.length; i++) {
        const rowText = rows[i].innerText.toLowerCase();
        rows[i].style.display = rowText.includes(input) ? "" : "none";
    }
}

const rowsPerPage = 5;
let currentPage = 1;

function paginateTable() {
    const tbody = document.getElementById("employee-table-body");
    const rows = Array.from(tbody.getElementsByTagName("tr"));
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    const paginationDiv = document.getElementById("pagination-controls");

    rows.forEach((row, index) => {
        row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
    });

    paginationDiv.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = i === currentPage ? "active-page" : "";
        btn.onclick = () => {
            currentPage = i;
            paginateTable();
        };
        paginationDiv.appendChild(btn);
    }
}

function openEditModal(employeeId) {
    fetch(`/bopo_admin/get-employee/${employeeId}/`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("edit_employee_id").value = data.id;
            document.getElementById("edit_employee_name").value = data.name;
            document.getElementById("edit_email").value = data.email;
            document.getElementById("edit_aadhaar").value = data.aadhaar;
            document.getElementById("edit_address").value = data.address;
            document.getElementById("edit_username").value = data.username;
            document.getElementById("edit_password").value = data.password;
            document.getElementById("edit_confirmPassword").value = data.password;
            document.getElementById("edit_mobile").value = data.mobile;
            document.getElementById("edit_pan").value = data.pan;
            document.getElementById("edit_pincode").value = data.pincode;

            // Fetch states and set the selected state
            fetchStates().then(() => {
                const stateDropdown = document.getElementById("edit_state");
                stateDropdown.value = data.state;

                // Fetch cities for the selected state and set the selected city
                fetchCities(data.state).then(() => {
                    const cityDropdown = document.getElementById("edit_city");
                    cityDropdown.value = data.city;
                });
            });

            document.getElementById("editModal").style.display = "block";
        });
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

function fetchStates() {
    return fetch("/bopo_admin/get-states/")
        .then(response => response.json())
        .then(states => {
            console.log(states);  // Check if states are being returned
            const stateDropdown = document.getElementById("edit_state");
            stateDropdown.innerHTML = '<option value="">Select State</option>';
            states.forEach(state => {
                let option = document.createElement("option");
                option.value = state.id;
                option.textContent = state.name;
                stateDropdown.appendChild(option);
            });
        });
}

function fetchCities(state) {
    return fetch(`/bopo_admin/get-cities/${state}/`)
        .then(res => res.json())
        .then(cities => {
            const cityDropdown = document.getElementById("edit_city");
            cityDropdown.innerHTML = '<option value="">Select City</option>';
            cities.forEach(city => {
                let option = document.createElement("option");
                option.value = city.id;
                option.textContent = city.name;
                cityDropdown.appendChild(option);
            });
        });
}

function togglePassword(id) {
    const passwordInput = document.getElementById(id);
    const icon = passwordInput.nextElementSibling.querySelector("i");
    if (passwordInput.type === "password") {
        passwordInput.type = "text";
        icon.classList.replace("fa-eye", "fa-eye-slash");
    } else {
        passwordInput.type = "password";
        icon.classList.replace("fa-eye-slash", "fa-eye");
    }
}

document.getElementById("editEmployeeForm").addEventListener("submit", function (event) {
    event.preventDefault();
    const pwd = document.getElementById("edit_password").value;
    const confirmPwd = document.getElementById("edit_confirmPassword").value;

    if (pwd !== confirmPwd) {
        document.getElementById("password-error").style.display = "block";
        return;
    } else {
        document.getElementById("password-error").style.display = "none";
    }

    const formData = new FormData(this);

    fetch("/bopo_admin/update-employee/", {
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Employee updated successfully!");
                closeEditModal();
                location.reload();
            } else {
                alert("There was an error updating the employee.");
            }
        })
        .catch(error => console.error("Error:", error));
});

function getCookie(name) {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.split('=')[1]);
            break;
        }
    }
    return cookieValue;
}


function deleteEmployee(employeeId) {
    if (confirm("Are you sure you want to delete this employee?")) {
        fetch(`/bopo_admin/delete-employee/${employeeId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Employee deleted successfully!");
                // Remove the employee row from the table
                const row = document.querySelector(`#employee-table-body tr[data-id="${employeeId}"]`);
                row.remove();
            } else {
                alert("Error deleting employee.");
            }
        })
        .catch(error => console.error('Error:', error));
    }
}



</script>
{% endblock %}
