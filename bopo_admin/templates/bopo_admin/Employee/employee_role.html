{% extends "bopo_admin/base.html" %}
{% load static %}

{% block content %}
<!-- CSS -->
<link rel="stylesheet" type="text/css" href="{% static 'bopo_admin/css/employee_role.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<!-- Back to List Button -->
<div class="send_credentials-back-to-list-btn">
    <a href="{% url 'employee_list' %}" class="send_credentials-add_individual_merchant-btn-submit">
        <i class="fa fa-arrow-left"></i> Back 
    </a>
</div>

<!-- Page Title -->
<h2 class="page-title">Assign Employee Roles</h2>

<!-- Form Start -->
<div class="container">
    <form method="POST" action="{% url 'assign_employee_role' %}">
        {% csrf_token %}
        
        <!-- Employee Dropdown -->
        <div class="dropdown-container">
            <label for="employee">Employee:</label>
            <select id="employee" name="employee_id" class="employee-select" required>
                <option value="">Select Employee</option>
                {% for emp in employees %}
                    <option value="{{ emp.employee_id }}">{{ emp.name }}</option>
                {% endfor %}
            </select>
        </div><br>
        
        <!-- Select All Roles Checkbox -->
        <div class="select-all-container">
            <input type="checkbox" id="select_all" />
            <label for="select_all" class="select-all-label">Select All Roles</label>
        </div>

        <!-- Roles Checkboxes -->
        <div class="roles-container">
            <div class="role-group">
                <input type="checkbox" id="corporate_merchant" name="roles" value="Corporate Merchant">
                <label for="corporate_merchant">Corporate Merchant</label>

                <input type="checkbox" id="individual_merchant" name="roles" value="Individual Merchant">
                <label for="individual_merchant">Individual Merchant</label>

               <input type="checkbox" id="terminals" name="roles" value="terminals">
                <label for="terminals">Terminals</label>

                    <input type="checkbox" id="reduce_limit" name="roles" value="reduce_limit">
                <label for="reduce_limit">Reduce Merchant Points</label>

                <input type="checkbox" id="superadmin_functionality" name="roles" value="superadmin_functionality">
<label for="superadmin_functionality">SuperAdmin Functionality</label>

                <input type="checkbox" id="merchant_send_credentials" name="roles" value="Merchant Send Credentials">
                <label for="merchant_send_credentials">Merchant Send Credentials</label>

            

                
                {% comment %} <input type="checkbox" id="merchant_limit" name="roles" value="Merchant Limit">
                <label for="merchant_limit">Merchant Limit</label> {% endcomment %}

                {% comment %} <input type="checkbox" id="merchant_login" name="roles" value="Merchant Login Page-Info">
                <label for="merchant_login">Merchant Login Page-Info</label> {% endcomment %}
            </div>

            <div class="role-group">
                <input type="checkbox" id="merchant_notification" name="roles" value="Merchant Send Notification">
                <label for="merchant_notification">Merchant Send Notification</label>

                {% comment %} <input type="checkbox" id="merchant_offers" name="roles" value="Merchant Received Offers">
                <label for="merchant_offers">Merchant Received Offers</label> {% endcomment %}

                <input type="checkbox" id="modify_customer" name="roles" value="Modify Customer Details">
                <label for="modify_customer">Modify Customer Details</label>

                <input type="checkbox" id="customer_notification" name="roles" value="Customer Send Notification">
                <label for="customer_notification">Customer Send Notification</label>

                <input type="checkbox" id="create_employee" name="roles" value="Create Employee">
                <label for="create_employee">Create Employee</label>

                <input type="checkbox" id="payment_details" name="roles" value="Payment Details">
                <label for="payment_details">Top-Up Request</label>
            </div>

            <div class="role-group">    
               
                <input type="checkbox" id="account_info" name="roles" value="Account-Info">
                <label for="account_info">Account-Info</label>

                <input type="checkbox" id="reports" name="roles" value="Reports">
                <label for="reports">Reports</label>

                {% comment %} <input type="checkbox" id="deduct_amount" name="roles" value="Deduct Amount">
                <label for="deduct_amount">Deduct Amount</label> {% endcomment %}

              

                <input type="checkbox" id="helpdesk_action" name="roles" value="HelpDesk Action">
                <label for="helpdesk_action">HelpDesk Action</label>
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="employee-role-button-group">
            <button type="button" class="employee-role-cancel-btn" onclick="confirmCancel()">
                <i class="fa fa-times-circle"></i> Cancel
            </button>
            <button type="submit" class="employee-role-submit-btn">
                <i class="fa fa-check-circle"></i> Submit
            </button>
        </div>
    </form>
</div>

{% if messages %}
<div id="toast" class="toast-container toast-show">
    {% for message in messages %}
        <div class="toast-message {{ message.tags }}">
            <i class="fa fa-exclamation-circle"></i>
            <span>{{ message }}</span>
        </div>
    {% endfor %}
</div>
{% endif %}



<!-- Select All Role JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Remove toast after 3.5s
    setTimeout(() => {
        const toast = document.querySelector('.toast-container');
        if (toast) toast.remove();
    }, 3500);

    const selectAll = document.getElementById('select_all');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="roles"]');

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            if (selectAll) {
                selectAll.checked = [...checkboxes].every(cb => cb.checked);
            }
        });
    });

    // Initialize Select2 on employee dropdown
    if ($('#employee').length) {
        $('#employee').select2({
            placeholder: "Select Employee",
            allowClear: true
        });

        // AJAX load roles for selected employee
        $('#employee').on('change', function () {
            const employeeId = $(this).val();

            // Uncheck all role checkboxes initially
            $('input[name="roles"]').prop('checked', false);
            $('#select_all').prop('checked', false);

            if (employeeId) {
                $.ajax({
                    url: "{% url 'get_employee_roles' %}",
                    data: { employee_id: employeeId },
                    success: function (response) {
                        const roles = response.roles;
                        for (const [key, value] of Object.entries(roles)) {
                            if (value) {
                                $(`input[name="roles"][value="${convertKeyToLabel(key)}"]`).prop('checked', true);
                            }
                        }

                        // Update Select All state
                        const allChecked = $('input[name="roles"]').length === $('input[name="roles"]:checked').length;
                        $('#select_all').prop('checked', allChecked);
                    }
                });
            }
        });
    }

    // Cancel confirmation modal logic
    const dismissBtn = document.getElementById("dismissCancel");
    const confirmBtn = document.getElementById("confirmCancel");
    const closeModalBtn = document.getElementById("closeCancelModal");

    if (dismissBtn) {
        dismissBtn.addEventListener("click", () => {
            document.getElementById("cancelConfirmationModal").style.display = "none";
        });
    }

    if (confirmBtn) {
        confirmBtn.addEventListener("click", () => {
            window.location.href = "{% url 'home' %}";
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener("click", () => {
            document.getElementById("cancelConfirmationModal").style.display = "none";
        });
    }
});

// Show cancel modal
function confirmCancel() {
    const modal = document.getElementById("cancelConfirmationModal");
    if (modal) modal.style.display = "block";
}

// Role key-to-label converter
function convertKeyToLabel(key) {
    const map = {
        corporate_merchant: "Corporate Merchant",
        individual_merchant: "Individual Merchant",
        terminals: "terminals",
        merchant_send_credentials: "Merchant Send Credentials",
        reduce_limit: "reduce_limit",
        merchant_limit: "Merchant Limit",
        merchant_login_page_info: "Merchant Login Page-Info",
        merchant_send_notification: "Merchant Send Notification",
        merchant_received_offers: "Merchant Received Offers",
        modify_customer_details: "Modify Customer Details",
        customer_send_notification: "Customer Send Notification",
        create_employee: "Create Employee",
        payment_details: "Payment Details",
        account_info: "Account-Info",
        reports: "Reports",
        deduct_amount: "Deduct Amount",
        superadmin_functionality: 'superadmin_functionality',
        helpdesk_action: "HelpDesk Action",
    };
    return map[key] || key;
}
</script>

{% endblock %}
