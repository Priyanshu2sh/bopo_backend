{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Set New Password - BOPO</title>
    <link rel="stylesheet" href="{% static 'bopo_admin/css/pass_reset.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
    <div class="colorful-line"></div>

    <div class="center-wrapper">

        <div class="login-header">
            <h2><span>{% if user_type == 'corporate' %}Set New PIN{% else %}Set a New Password{% endif %}</span></h2>
            <p>{% if user_type == 'corporate' %}Enter your 4-digit PIN below.{% else %}Please enter your new password below.{% endif %}</p>

            <div class="login-container">

                {% if messages %}
                    {% for message in messages %}
                        <div class="custom-alert {% if message.tags %}{{ message.tags }}{% endif %}">
                            <span class="icon">
                                {% if "success" in message.tags %}
                                    ✅
                                {% else %}
                                    ⚠️
                                {% endif %}
                            </span>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                {% if form %}
                    <form method="post" novalidate>
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="form-group">
                                <label for="{{ field.id_for_label }}">
                                    {% if user_type == 'corporate' and field.label == "New password" %}
                                        New PIN
                                    {% elif user_type == 'corporate' and field.label == "New password confirmation" %}
                                        Confirm PIN
                                    {% else %}
                                        {{ field.label }}
                                    {% endif %}
                                </label>
                                <div class="input-wrapper">
                                    {{ field }}
                                    {% if field.field.widget.input_type == "password" %}
                                        <span class="toggle-password" onclick="togglePasswordVisibility('{{ field.id_for_label }}', this)">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </span>
                                    {% endif %}
                                    {% if field.errors %}
                                        <div class="custom-alert error">
                                            <span class="icon">⚠️</span>
                                            {{ field.errors|striptags }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                        <button type="submit">{% if user_type == 'corporate' %}Change PIN{% else %}Change Password{% endif %}</button>
                    </form>
                {% endif %}

            </div>

            <div class="back-to-login">
                <a href="{% url 'login' %}"><i class="fa-solid fa-arrow-left"></i> Back to Login</a>
            </div>
        </div>
    </div>

    <div class="footer-text">
        &copy; 2025 BOPO. All rights reserved.
    </div>

    <script>
        function togglePasswordVisibility(fieldId, toggleElement) {
            const input = document.getElementById(fieldId);
            const icon = toggleElement.querySelector("i");
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            }
        }

        // If the user is corporate, add frontend restrictions to password fields
        document.addEventListener("DOMContentLoaded", function () {
            const userType = "{{ user_type }}";

            if (userType === "corporate") {
                const passwordFields = document.querySelectorAll('input[type="password"]');
                passwordFields.forEach(field => {
                    field.setAttribute('maxlength', '4');
                    field.setAttribute('inputmode', 'numeric');
                    field.addEventListener('input', function () {
                        this.value = this.value.replace(/\D/g, ''); // Only allow digits
                    });
                });
            }
        });
    </script>
</body>
</html>
