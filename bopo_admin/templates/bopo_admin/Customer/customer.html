{% extends "bopo_admin/base.html" %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/customer.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 <!-- jQuery (required for Select2) -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 <!-- Select2 CSS & JS -->
 <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
 <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="customer-container">
    <div class="customer-header">
        <h2>Customer List</h2>
        <div class="customer-buttons">
            <button class="add-customer-btn" onclick="openModal()">+ Add Customer</button>
            <button class="send-customer-btn" onclick="window.location.href='{% url 'send_customer_notifications' %}'">
                + Send Notifications
            </button>
        </div>
    </div>

    <div class="customer-list">
        <div class="customer-table">
            <input type="text" class="search-box" id="search-corporate" onkeyup="filterTable('corporate-table', 'search-corporate')" placeholder="Search corporate customers...">
            <table id="corporate-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Customer ID</th>
                        <th>Contact Person</th>
                        <th>Mobile Number</th>
                        <th>City</th>
                        <th>Verified</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>1</td>
                        <td>Demo Contact</td>
                        <td>9090909090</td>
                        <td>Pune</td>
                        <td>true</td>
                        <td>
                            <button onclick="editCustomer(1, 'Demo', 'Contact', 'demo@example.com', '9090909090', 25, 'Male', 'Pune', '411001', 'Some Address', 1)">‚úèÔ∏è</button>
                            <button onclick="deleteCustomer({{ customer.id }})">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% for customer in customers %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ customer.id }}</td>
                      <td>{{ customer.contact_person }}</td>
                      <td>{{ customer.mobile }}</td>
                      <td>{{ customer.city.name }}</td>
                      <td>{{ customer.verified }}</td>
                      <td>
                        <button onclick="editCustomer(
                            '{{ customer.id }}',
                            '{{ customer.first_name }}',
                            '{{ customer.last_name }}',
                            '{{ customer.email }}',
                            '{{ customer.mobile }}',
                            '{{ customer.age }}',
                            '{{ customer.gender }}',
                            '{{ customer.aadhaar_number }}',
                            '{{ customer.pan_number }}',
                            '{{ customer.city.id }}',
                            '{{ customer.pincode }}',
                            `{{ customer.address|escapejs }}`,
                            '{{ customer.state.id }}'
                        )" class="btn btn-sm btn-warning">‚úèÔ∏è Edit</button>
                      </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Modal: Add Customer -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Add New Customer</h2>

        <form id="customerForm" class="form-container" method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="firstName">First Name:</label>
                <div class="input-container">
                    <i class="fas fa-user"></i>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
            </div>

            <div class="form-group">
                <label for="lastName">Last Name:</label>
                <div class="input-container">
                    <i class="fas fa-user"></i>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>

            <div class="form-group">
                <label for="email">Email ID:</label>
                <div class="input-container">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" name="email" >
                </div>
            </div>

            <div class="form-group">
                <label for="mobile">Mobile Number:</label>
                <div class="input-container">
                    <i class="fas fa-mobile-alt"></i>
                    <input type="tel" id="mobile" name="mobile" pattern="[0-9]{10}" required placeholder="Enter 10-digit Mobile Number">
                </div>
            </div>

            <div class="form-group">
                <label for="age">Age:</label>
                <div class="input-container">
                    <i class="fa fa-calendar"></i>
                    <input type="number" id="age" name="age" required>
                </div>
            </div>

            <div class="form-group">
                <label for="gender">Gender:</label>
                <div class="input-container">
                    <select id="gender" name="gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="aadhar">Aadhar Number:</label>
                <div class="input-container">
                    <i class="fas fa-id-card"></i>
                    <input type="text" id="aadhar_number" name="aadhar_number" pattern="\d{12}" maxlength="12"  placeholder="Enter 12-digit Aadhar Number">
                </div>
            </div>
            
            <div class="form-group">
                <label for="pan">PAN Number:</label>
                <div class="input-container">
                    <i class="fas fa-id-badge"></i>
                    <input type="text" id="pan_number" name="pan_number" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10"  placeholder="Enter valid PAN Number">
                </div>
            </div>
            

            <div class="form-group" style="grid-column: span 2;">
                <label for="address">Address:</label>
                <div class="input-container">
                    <i class="fas fa-map-marker-alt"></i>
                    <textarea id="address" name="address" required></textarea>
                </div>
            </div>

            <div class="form-group">
                <label for="country">Country:</label>
                <div class="input-container">
                    <input type="text" id="country" name="country" value="India" disabled>
                </div>
            </div>

            <div class="form-group">
                <label for="state">Select State:</label>
                <div class="input-container">
                    <select id="state" name="state" class="select2" onchange="fetchCities()" required>
                        <option value="">Select State</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="city">Select City:</label>
                <div class="input-container">
                    <select id="city" name="city" class="select2" required>
                        <option value="">Select City</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="pincode">Pincode:</label>
                <div class="input-container">
                    <i class="fas fa-home"></i>
                    <input type="text" id="pincode" name="pincode" pattern="[0-9]{6}" maxlength="6" title="Please enter a 6-digit pincode" required>

                </div>
            </div>

            <div class="form-actions">
                <button type="submit">Submit</button>
            </div>
        </form>
    </div>
</div>


<!-- JavaScript for Modal and Dynamic City Dropdown -->
<script>
        function openModal() {
            document.getElementById("customerModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("customerModal").style.display = "none";
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            let modal = document.getElementById("customerModal");
            if (event.target == modal) {
                closeModal();
            }
        };
</script>



<!-- JavaScript for Search Filtering and Modal -->
<script>
    function filterTable(tableId, searchBoxId) {
        let input = document.getElementById(searchBoxId);
        let filter = input.value.toLowerCase();
        let table = document.getElementById(tableId);
        let rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) {
            let rowText = rows[i].innerText.toLowerCase();
            if (rowText.includes(filter)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
</script>




<!-- Success Toast -->
<div id="toast-success" class="toast-container">
    <i class="fa fa-check-circle"></i>
    <span class="toast-message">Customer added successfully!</span>
</div>

<!-- Info Toast -->
<div id="toast-info" class="toast-container">
    <i class="fa fa-info-circle"></i>
    <span id="toast-message" class="toast-message">Message goes here</span>
</div>



<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <p>Are you sure you want to delete this customer?</p>
        <div class="modal-actions">
            <button type="button" onclick="confirmDelete()" class="btn btn-confirm">Yes, Delete</button>
            <button onclick="cancelDelete()" class="btn btn-cancel">Cancel</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchStates();

        $('.select2').select2({
            placeholder: "Select an option",
            allowClear: true,
            width: '100%'
        });

        document.querySelector("form").addEventListener("submit", function (event) {
            event.preventDefault();

            let toast = document.getElementById("toast-success");
            toast.classList.add("toast-show");

            setTimeout(function () {
                toast.classList.add("toast-hide");
                setTimeout(() => {
                    toast.classList.remove("toast-show", "toast-hide");
                    document.querySelector("form").submit(); // or handle manually if needed
                }, 500);
            }, 3000);
        });
    });

    function fetchStates() {
        fetch("/bopo_admin/get-states/")
            .then(response => response.json())
            .then(data => {
                let stateDropdown = document.getElementById("state");
                stateDropdown.innerHTML = '<option value="">Select State</option>';
                data.forEach(state => {
                    let option = document.createElement("option");
                    option.value = state.id;
                    option.textContent = state.name;
                    stateDropdown.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching states:", error));
    }

    function fetchCities() {
        let stateId = document.getElementById("state").value;
        let cityDropdown = document.getElementById("city");
        cityDropdown.innerHTML = '<option value="">Select City</option>';

        if (stateId) {
            fetch(`/bopo_admin/get-cities/${stateId}/`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(city => {
                        let option = document.createElement("option");
                        option.value = city.id;
                        option.textContent = city.name;
                        cityDropdown.appendChild(option);
                    });
                    $('#city').trigger('change');
                })
                .catch(error => console.error("Error fetching cities:", error));
        }
    }


//edit
    function editCustomer(id, firstName, lastName, email, mobile, age, gender,aadhar_number,pan_number, cityId, pincode, address, stateId) {
        // Set form action to update mode
        const form = document.getElementById("customerForm");
        form.action = `/bopo_admin/update-customer/${id}/`; // Or update via AJAX if needed
        form.dataset.editing = "true";
    
        // Fill form fields
        document.getElementById("firstName").value = firstName;
        document.getElementById("lastName").value = lastName;
        document.getElementById("email").value = email;
        document.getElementById("mobile").value = mobile;
        document.getElementById("age").value = age;
        document.getElementById("gender").value = gender;
        document.getElementById("aadhar_number").value = aadhar_number;
        document.getElementById("pan_number").value = pan_number;
        document.getElementById("address").value = address;
        document.getElementById("pincode").value = pincode;
    
        // Set state and trigger fetchCities
        const stateSelect = document.getElementById("state");
        stateSelect.value = stateId;
    
        fetchCities(() => {
            document.getElementById("city").value = cityId;
            $('#city').trigger('change');
        });
    
        openModal();
    }

//delete
let selectedCustomerId = null;

    function deleteCustomer(customerId) {
        selectedCustomerId = customerId;
        document.getElementById("confirmModal").style.display = "block";
    }

    function confirmDelete() {
        if (selectedCustomerId) {
            // Redirect to delete URL or make AJAX call
            window.location.href = `/bopo_admin/delete-customer/${selectedCustomerId}/`;
        }
    }

    function cancelDelete() {
        selectedCustomerId = null;
        document.getElementById("confirmModal").style.display = "none";
    }

    // Close confirm modal if clicked outside
    window.onclick = function(event) {
        const confirmModal = document.getElementById("confirmModal");
        if (event.target === confirmModal) {
            cancelDelete();
        }
    };

function showToast(message, type) {
    let toast;
    if (type === "success") {
        toast = document.getElementById("toast-success");
        toast.querySelector('.toast-message').textContent = message;
    } else {
        toast = document.getElementById("toast-info");
        toast.querySelector('.toast-message').textContent = message;
    }

    toast.classList.add("toast-show");

    setTimeout(() => {
        toast.classList.add("toast-hide");
        setTimeout(() => {
            toast.classList.remove("toast-show", "toast-hide");
        }, 500);
    }, 3000);
}
    
</script>






{% endblock %}
