{% extends "bopo_admin/base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'bopo_admin/css/customer.css' %}">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 <!-- jQuery (required for Select2) -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 <!-- Select2 CSS & JS -->
 <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
 <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="customer-container">
    <div class="customer-header">
        <h2>Customer List</h2>
        <div class="customer-buttons">
            <button class="add-customer-btn" onclick="window.location.href='{% url 'add_customer' %}'">
                + Add Customer
            </button>
            <button class="send-customer-btn" onclick="window.location.href='{% url 'send_customer_notifications' %}'">
                + Send Notifications
            </button>
        </div>
    </div>

    <div class="customer-list">
        <div class="customer-table">
            <input type="text" class="search-box" id="search-customer" onkeyup="filterTable('customer-table-body', 'search-customer')" placeholder="Search customers...">
            <table id="customer-table-body">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Customer ID</th>
                        <th>Contact Person</th>
                        <th>Mobile Number</th>
                        <th>City</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ customer.customer_id }}</td>
                        <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                        <td>{{ customer.mobile }}</td>
                        <td>{{ customer.city }}</td>
                        <td><label class="switch"><input type="checkbox" {% if customer.status == "Active" %}checked{% endif %} data-id="{{ customer.id }}" class="customer-status-toggle"><span class="slider round"></span></label></td>
                      <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal('{{ customer.customer_id }}')">‚úèÔ∏è Edit</button>

                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('{{ customer.customer_id}}')">üóëÔ∏è Delete</button>

                      </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="pagination-controls" class="pagination-controls"></div>
        </div>
    </div>
</div>


<div id="editCustomerModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Edit Customer</h2>
        <form id="editCustomerForm" method="POST" >
            {% csrf_token %}
            <input type="hidden" id="editCustomerId" name="edit_customer_id">


            <div class="addcustomer-form-container">
             <!-- Left Column -->
                <div class="addcustomer-form-group">


                   <label for="first_name">First Name</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-user"></i>
                        <input type="text"  id="edit_first_name" name="first_name" pattern="[A-Za-z\s]+" title="Only letters and spaces allowed" required>
                    </div>

                    <label for="email">Email ID</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="edit_email" name="email" >
                    </div>

                    <label for="age">Age</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-calendar"></i>
                        <input type="number" id="edit_age" name="age" min="1" max="120" title="Enter age between 1 and 120" required>
                    </div>

                    <label for="aadhaar">Aadhaar Number</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-id-card"></i>
                        <input type="text" id="edit_aadhaar" name=" aadhar_number" pattern="\d{12}" maxlength="12" title="Enter a 12-digit Aadhaar number" >
                    </div>

                    <label for="address">Address</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="edit_address" name="address" required>
                    </div>

                    <label for="city">Select City </label>
                    <select id="edit_city" name="city" class="select2">
                        <option value="">Select City</option>
                    </select>

                   
                    <label for="country">Country</label>
                    <div class="addcustomer-input-container">
                        <input type="text" name="country" value="India" disabled>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="addcustomer-form-group">

                    <label for="last_name">Last Name</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-user"></i>
                        <input type="text" id="edit_last_name" name="last_name" pattern="[A-Za-z\s]+" title="Only letters and spaces allowed" required>
                    </div>

                    <label for="mobile">Mobile Number</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-mobile-alt"></i>
                        <input type="tel" id="edit_mobile" name="mobile" pattern="\d{10}" maxlength="10" title="Enter a 10-digit mobile number" required>
                    </div>

                    <label for="gender">Gender</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-venus-mars"></i>
                        <select name="gender" id="edit_gender"required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                            
                   
                    <label for="pan">Pan Number</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-id-card"></i>
                        <input type="text" name="pan" id="edit_pan" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" title="Enter valid PAN (e.g., ABCDE1234F)">
                    </div>

                    <label for="state">Select State </label>
                    <select id="edit_state" name="state" class="select2" onchange="fetchCities()">
                        <option value="">Select State</option>
                    </select>

                 
                    <label for="pincode">Pincode</label>
                    <div class="addcustomer-input-container">
                        <i class="fas fa-home"></i>
                        <input type="text" id="edit_pincode" name="pincode" pattern="\d{6}" maxlength="6" title="Enter a 6-digit pincode">
                    </div>
                </div>
            </div>

            <button type="submit" class="addcustomer-btn-submit">Submit</button>
        </form>
    </div>
</div>
<div>


   <!-- Toast Notification -->
   <div id="toast" class="toast-container {% if message %}toast-show{% endif %}">
    <i class="fa fa-exclamation-circle"></i>
    <span class="toast-message">{{ message }}</span>
</div>


<!-- JavaScript for Search Filtering and Modal -->
<script>

    function openEditModal(customerId) {
        document.getElementById("editCustomerId").value = customerId;
    
        fetch(`/bopo_admin/get-customer/${customerId}/`)
            .then(response => response.json())
            .then(async customer => {
                // Set basic fields
                document.getElementById("edit_first_name").value = customer.first_name;
                document.getElementById("edit_last_name").value = customer.last_name;
                document.getElementById("edit_email").value = customer.email;
                document.getElementById("edit_mobile").value = customer.mobile;
                document.getElementById("edit_age").value = customer.age;
                document.getElementById("edit_aadhaar").value = customer. aadhar_number;
                document.getElementById("edit_address").value = customer.address;
                document.getElementById("edit_pincode").value = customer.pincode;
                document.getElementById("edit_gender").value = customer.gender;
                document.getElementById("edit_pan").value = customer.pan;
    
                // First populate states
                await fetchStates();
                document.getElementById("edit_state").value = customer.state_id;
    
                // Then populate cities for selected state
                await fetchCities(customer.state_id);
                document.getElementById("edit_city").value = customer.city_id;
    
                // Refresh Select2 UI
                $('#edit_state').trigger('change.select2');
                $('#edit_city').trigger('change.select2');
            });
    
        // Show modal
        document.getElementById("editCustomerModal").style.display = "block";
    }
    
    function closeEditModal() {
        document.getElementById("editCustomerModal").style.display = "none";
    }
    

    window.onclick = function(event) {
        let modal = document.getElementById("editCustomerModal");
        if (event.target == modal) {
            closeEditModal();
        }
    };
    

    function filterTable(tableId, searchBoxId) {
        let input = document.getElementById(searchBoxId);
        let filter = input.value.toLowerCase();
        let table = document.getElementById(tableId);
        let rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) {
            let rowText = rows[i].innerText.toLowerCase();
            if (rowText.includes(filter)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchStates();
        paginateTable();
    
        $('.select2').select2({
            placeholder: "Select an option",
            allowClear: true,
            width: '100%'
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("editCustomerForm").addEventListener("submit", function (event) {
            event.preventDefault();
    
            let formData = new FormData(this);
    
            fetch(`/bopo_admin/update-customer/${document.getElementById("editCustomerId").value}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")  // Ensure the CSRF token is being sent
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("Server response:", data); // Debug
                if (data.status === "success") {
                    showToast(data.message, "success");
                    closeEditModal();
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    showToast(data.message, "error");
                }
            })
            .catch(error => {
                showToast("Error occurred: " + error.message, "error");
            });
        });
    });
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
    
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function closeEditModal() {
        document.getElementById("editCustomerModal").style.display = "none";
    }
    
    
    function showToast(message, type) {
        const toast = document.getElementById("toast");
        const toastMessage = toast.querySelector(".toast-message");
        toastMessage.textContent = message;
    
        toast.classList.add("toast-show");
    
        setTimeout(() => {
            toast.classList.add("toast-hide");
            setTimeout(() => {
                toast.classList.remove("toast-show", "toast-hide");
            }, 500);
        }, 3000);
    }
    
    <script>
        function deleteCustomer(customerId) {
            // Show confirmation toast message
            const confirmationToast = showToast("Are you sure you want to delete this customer?", "warning", true);
            
            // Wait for confirmation
            confirmationToast.querySelector('.toast-message').addEventListener('click', function() {
                // Send delete request if confirmed
                fetch(`/bopo_admin/delete-customer/${customerId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        showToast(data.message, "success");
                        location.reload();  // Reload page to update the customer list
                    } else {
                        showToast(data.message, "error");
                    }
                })
                .catch(error => {
                    showToast("Error occurred: " + error.message, "error");
                });
            });
        }
        
        // Function to display toast notifications
        function showToast(message, type, isConfirmation = false) {
            const toast = document.getElementById("toast");
            const toastMessage = toast.querySelector(".toast-message");
            toastMessage.textContent = message;
            
            toast.classList.add("toast-show");
            
            if (isConfirmation) {
                toastMessage.innerHTML += '<button class="toast-confirm">Confirm</button>';
            }
            
            setTimeout(() => {
                toast.classList.add("toast-hide");
                setTimeout(() => {
                    toast.classList.remove("toast-show", "toast-hide");
                }, 500);
            }, 3000);
            
            return toast;
        }
    
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
        
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
 
    









    

function fetchStates() {
    return fetch("/bopo_admin/get-states/")
        .then(response => response.json())
        .then(states => {
            const stateDropdown = document.getElementById("edit_state");
            stateDropdown.innerHTML = '<option value="">Select State</option>';
            states.forEach(state => {
                let option = document.createElement("option");
                option.value = state.id;
                option.textContent = state.name;
                stateDropdown.appendChild(option);
            });
        });
}

function fetchCities(state) {
    const stateId = state || document.getElementById("edit_state").value;
    return fetch(`/bopo_admin/get-cities/${stateId}/`)
        .then(res => res.json())
        .then(cities => {
            const cityDropdown = document.getElementById("edit_city");
            cityDropdown.innerHTML = '<option value="">Select City</option>';
            cities.forEach(city => {
                let option = document.createElement("option");
                option.value = city.id;
                option.textContent = city.name;
                cityDropdown.appendChild(option);
            });
        });
}


const rowsPerPage = 5;
let currentPage = 1;

function paginateTable() {
    const table = document.getElementById("customer-table");
    const tbody = document.getElementById("customer-table-body");
    const rows = Array.from(tbody.getElementsByTagName("tr"));
    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const paginationDiv = document.getElementById("pagination-controls");

    // Hide all rows
    rows.forEach((row, index) => {
        row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
    });

    // Clear previous pagination
    paginationDiv.innerHTML = "";

    // Add new pagination buttons
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = i === currentPage ? "active-page" : "";
        btn.onclick = () => {
            currentPage = i;
            paginateTable();
        };
        paginationDiv.appendChild(btn);
    }
}

window.onload = paginateTable;



    
</script>






{% endblock %}