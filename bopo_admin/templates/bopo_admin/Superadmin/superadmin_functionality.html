{% extends "bopo_admin/base.html" %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/superadmin_func.css' %}">

<div class="send-notification-container">
    <div class="back-to-list-btn">
        <a href="{% url 'reports' %}" class="addcustomer-btn-submit">
            <i class="fa fa-arrow-left"></i> Back
        </a>
    </div>

    <div class="send-notification-header">
        <h2>Superadmin Functionality</h2>
    </div>

    <div class="send-notification-list">
        
        <!-- Deduct Amount -->
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-all-customers" class="toggle-checkbox">
            <label for="toggle-all-customers" class="send-notification-label">
                <span class="send-notification-icon">üí∞</span>
                <span>Deduct Percentage</span>
            </label>

            <div class="send-notification-form"><br>
                <div class="form-group">
                    <label for="deduct-amount">Deduct Amount Per Transaction:</label>
                    <input type="number" id="deduct-amount" class="form-control" placeholder="Enter percentage ">
                </div>

                <div class="button-container">
                    <button class="cancel-btn" onclick="confirmCancelDeduction()">Cancel</button>
                    <button class="send-btn" onclick="showAlert()">Save</button>
                </div>
            </div>
        </div>

        <!-- Security Questions -->
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-single-customer" class="toggle-checkbox">
            <label for="toggle-single-customer" class="send-notification-label">
                <span class="send-notification-icon">üîè</span>
                <span>Security Questions</span>
            </label>

            <div class="send-notification-form"><br>
                <table class="form-control" style="width: 100%; margin-bottom: 15px;">
                    <thead>
                        <tr><th>Question</th></tr>
                    </thead>
                    <tbody id="security-questions-body"></tbody>
                </table>

                <div id="add-question-row" style="display: none; margin-bottom: 15px;">
                    <input type="text" id="new-question" class="form-control" placeholder="Enter new security question">
                    <br>
                    <button class="send-btn" onclick="saveSecurityQuestion()">Save</button>
                    <button class="cancel-btn" onclick="cancelSecurityQuestion()">Cancel</button>
                </div>

                <button class="send-btn" onclick="showAddQuestion()">Add Question</button>
            </div>
        </div>

        <!-- Model Plans -->
       <!-- To Corporate Customers -->
<div class="send-notification-item">
    <input type="checkbox" id="toggle-corporate" class="toggle-checkbox">
    <label for="toggle-corporate" class="send-notification-label">
        <span class="send-notification-icon">üìä</span>
        <span>Model Plans</span>
    </label>

    <div class="send-notification-form">
        <!-- Rental Model -->
        <div class="model-card"><br>
            <h3 class="model-header">Model Plans</h3>
            <table class="plans-table">
                <thead>
                    <tr>
                        <th>Plan Validity</th>
                        <th>Plan Type</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in plans %}
                    <tr>
                        <td><span class="plan-validity-text">{{ plan.plan_validity }}</span></td>
                        <td><span class="plan-type-text">{{ plan.plan_type }}</span></td>
                        <td><span class="plan-description-text">{{ plan.description }}</span></td>
                        <td><button class="btn-action" onclick="openEditPlanModal(this)">Change</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

       </div>
</div>


<!-- Edit Plan Modal -->
<div id="editPlanModal" class="modal-container">
    <div class="modal-content-box">
        <span class="modal-close-btn" onclick="closeEditModal()">&times;</span>
        <h2 class="modal-header">Edit Plan</h2>
        <form id="editPlanForm">
            <div class="input-group">
                <label for="edit-validity-input">Plan Validity</label>
                <input type="text" id="edit-validity-input" class="input-field" placeholder="Enter plan validity">
            </div>
            <div class="input-group">
                <label for="edit-type-input">Plan Type</label>
                <input type="text" id="edit-type-input" class="input-field" placeholder="Enter plan type">
            </div>
            <div class="input-group">
                <label for="edit-description-input">Description</label>
                <textarea id="edit-description-input" class="textarea-field" placeholder="Enter description..."></textarea>
            </div>
            <button type="button" class="btn-save" onclick="savePlanChanges()"> Save Changes</button>
        </form>
 ¬†¬†¬†</div>
</div>


        <!-- Award Points -->
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-merchant-wise" class="toggle-checkbox">
            <label for="toggle-merchant-wise" class="send-notification-label">
                <span class="send-notification-icon">‚≠ê</span>
                <span>Award Points</span>
            </label>

            <div class="send-notification-form"><br>
                <div class="form-group">
                    <label>Award Points:</label>
                    <div id="award-text">
                        <span id="award-display">
                            <span class="highlight-percentage">10%</span> of purchase amount awarded to customer (BBP)
                        </span>
                        <button class="awardsend-btn" onclick="editAward()">Change</button>
                    </div>

                    <div id="award-edit" style="display: none;">
                        <input type="number" id="award-input" class="form-control" placeholder="Enter percentage" value="10" min="0" max="100" style="width: 100px;">
                        <span>% of purchase amount awarded to customer (BBP)</span><br><br>
                        <button class="awardsend-btn1" onclick="saveAward()">Save</button>
                        <button class="cancel-btn" onclick="cancelAward()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".toggle-checkbox");
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                const form = this.closest(".send-notification-item").querySelector(".send-notification-form");
                document.querySelectorAll(".send-notification-form").forEach(f => {
                    if (f !== form) {
                        f.style.display = "none";
                        f.closest(".send-notification-item").querySelector(".toggle-checkbox").checked = false;
                    }
                });
                form.style.display = this.checked ? "block" : "none";
            });
        });
        document.querySelectorAll(".send-notification-form").forEach(form => form.style.display = "none");
        loadSecurityQuestions();
    });

    function showAlert() {
        const input = document.getElementById('deduct-amount');
        const value = parseFloat(input.value);
        if (isNaN(value) || value < 0) return alert("Please enter a valid percentage.");
    
        fetch('/api/set-deduct-amount/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ deduct_amount: value }),
        })
        .then(res => res.json().then(data => ({ status: res.status, body: data })))
        .then(({ status, body }) => {
            if (status === 200) {
                alert("Deduct amount saved successfully!");
                
                // Reload the page and close the form container
                document.getElementById('deduct-amount').value = ''; // Clear the input
                const formContainer = document.querySelector('.send-notification-form');
                if (formContainer) formContainer.style.display = 'none';  // Hide the form container
    
                // Optionally, reload the page after a short delay (1 second here)
                setTimeout(() => {
                    location.reload();  // Reload the page
                }, 1000);
            } else {
                alert(body.error || "Failed to save deduction.");
            }
        })
        .catch(() => alert("Something went wrong."));
    }
    

    function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) return decodeURIComponent(cookie.substring(name.length + 1));
        }
        return '';
    }

    function loadSecurityQuestions() {
        fetch('/api/security-questions/')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("security-questions-body");
            tbody.innerHTML = '';
            data.forEach(q => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${q.question}</td>`;
                tbody.appendChild(tr);
            });
        });
    }

    function showAddQuestion() {
        document.getElementById("add-question-row").style.display = "block";
    }

    function cancelSecurityQuestion() {
        document.getElementById("new-question").value = '';
        document.getElementById("add-question-row").style.display = "none";
    }

    function saveSecurityQuestion() {
        const question = document.getElementById("new-question").value;
        if (!question) return alert("Please enter a question.");
        fetch('/api/security-questions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ question })
        })
        .then(res => res.json())
        .then(() => {
            cancelSecurityQuestion();
            loadSecurityQuestions();
        });
    }

    function editAward() {
        document.getElementById('award-text').style.display = 'none';
        document.getElementById('award-edit').style.display = 'block';
    }

    function saveAward() {
        const value = document.getElementById('award-input').value;
        document.getElementById('award-display').innerText = `${value}% of purchase amount awarded to customer (BBP)`;
        cancelAward();
    }

    function cancelAward() {
        document.getElementById('award-edit').style.display = 'none';
        document.getElementById('award-text').style.display = 'block';
    }
    function confirmCancelDeduction() {
        document.getElementById("deduct-amount").value = '';
    }

    function saveAward() {
        const awardPercentage = document.getElementById("award-input").value.trim();
    
        if (awardPercentage === "") {
            alert("Please enter a valid percentage.");
            return;
        }
    
        fetch("/save-award-points/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({
                award_percentage: awardPercentage,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("award-display").innerHTML = `<span class="highlight-percentage">${awardPercentage}%</span> of purchase amount awarded to customer (BBP)`;
                cancelAward();
            } else {
                alert("Error: " + data.error);
            }
        });
    }
    
    // Helper to get CSRF token from cookie
    function getCSRFToken() {
        let cookieValue = null;
        const name = 'csrftoken';
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openEditPlanModal(button) {
        const row = button.closest("tr");
        const validity = row.querySelector(".plan-validity-text").textContent.trim();
        const type = row.querySelector(".plan-type-text").textContent.trim();
        const description = row.querySelector(".plan-description-text").textContent.trim();
    
        document.getElementById("edit-validity-input").value = validity;
        document.getElementById("edit-type-input").value = type;
        document.getElementById("edit-description-input").value = description;
    
        document.getElementById("editPlanModal").style.display = "block";

    }
    

    function closeEditModal() {
        document.getElementById('editPlanModal').style.display = 'none';
    }

    function savePlanChanges() {
        alert("Plan changes saved successfully!");
        closeEditModal();
    }

 

    function savePlanChanges() {
        const validity = document.getElementById("edit-validity-input").value.trim();
        const type = document.getElementById("edit-type-input").value.trim();
        const description = document.getElementById("edit-description-input").value.trim();
    
        fetch("/update-model-plan/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({
                plan_validity: validity,
                plan_type: type,
                description: description,
            }),
        })
        .then(response => response.json())
        .then((data) => {
            if (data.success) {
                alert("Plan changes saved successfully!");
                updateExistingModelPlanRow(type, validity, description); // Pass updated data
                closeEditModal();  // Close the modal after saving changes
            } else {
                alert("Error: " + data.error);
            }
        });
    }
    
    function updateExistingModelPlanRow(plan_type, plan_validity, description) {
        const rows = document.querySelectorAll(".plans-table tbody tr");
    
        rows.forEach((row) => {
            const currentType = row.querySelector(".plan-type-text")?.textContent.trim();
            if (currentType === plan_type.trim()) {
                row.querySelector(".plan-validity-text").textContent = plan_validity;
                row.querySelector(".plan-description-text").textContent = description;
            }
        });
    }
    
    
    
    // Helper to get CSRF token from cookie
    function getCSRFToken() {
        let cookieValue = null;
        const name = 'csrftoken';
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
