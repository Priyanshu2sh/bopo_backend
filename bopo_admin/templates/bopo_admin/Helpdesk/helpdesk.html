{% extends "bopo_admin/base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'bopo_admin/css/helpdesk.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<style>
    div.dataTables_filter { display: none !important; }

    .top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .search-box {
        padding: 6px 10px;
        width: 250px;
    }

    #custom-buttons {
        display: flex;
        justify-content: flex-end;
    }

    .dataTables_paginate {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .dataTables_paginate .paginate_button {
        background: linear-gradient(135deg, #ff7b54, #ff4e00);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(52, 49, 48, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
    }

    .dataTables_paginate .paginate_button:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #ff9a76, #ff6a2d);
        box-shadow: 0 6px 12px rgba(41, 39, 38, 0.4);
    }

    .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #333, #111);
        color: #fff;
        font-weight: bold;
        border: 2px solid #ff4e00;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.5);
    }

</style>

<div class="customer-container">
    <div class="customer-header">
        <h2>Helpdesk</h2>
        <div class="customer-buttons"></div>
    </div>

    <div class="customer-list">
        <div class="customer-table">
            <div class="top-controls">
                <input type="text" class="search-box" id="search-customer" placeholder="Search ...">
                <div id="custom-buttons"></div>
            </div>

            <table id="customer-table" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User ID</th>
                        <th>Contact Person</th>
                        <th>User Type</th>
                        <th>Query</th>
                        <th>Remark</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {%for help_request in help_requests %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        {% if help_request.merchant %}
                        <td>{{help_request.merchant.merchant_id}}</td>
                        <td>{{help_request.merchant.first_name}} {{help_request.merchant.last_name}}</td>
                        <td>Merchant</td>
                        <td>{{help_request.issue_description}}</td>
                        <td>{{ help_request.remark|default:"--" }}</td>
                  
                        {% elif help_request.customer %}
                        <td>{{help_request.customer_id}}</td>
                        <td>{{help_request.customer.first_name}} {{help_request.customer.last_name}}</td>
                        <td>Customer</td>
                        <td>{{help_request.issue_description}}</td>
                        <td>{{ help_request.remark|default:"--" }}</td>
                        {% endif %}
                        
                    
                            <td>
                                {% if help_request.status == "resolved" %}
                                    <button class="btn btn-sm btn-secondary" disabled>Resolved</button>

                                {% else %}
                                    <button class="btn btn-sm btn-warning status-btn" data-id="{{ help_request.id }}">Pending</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Toast -->
<div id="toast" class="toast-container {% if message %}toast-show{% endif %}">
    <i class="fa fa-exclamation-circle"></i>
    <span class="toast-message">{{ message }}</span>
</div>

<!-- Solution Modal -->
<div class="modal-container" id="solution-modal">
    <div class="modal-content-box">
        <span class="modal-close-btn" id="modal-close-btn">&times;</span>
        <div class="modal-header">Add Remark</div>
        <form id="solution-form">
            <input type="hidden" name="help_id" id="modal-help-id">
            <textarea id="solution-text" name="solution" placeholder="Enter remark..." rows="6" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;"></textarea>
            <button type="submit" class="send-btn">Submit</button>
        </form>
    </div>
</div>



<!-- Scripts -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<script>
    $(document).ready(function () {
        const table = $('#customer-table').DataTable({
            dom: 'Bfrtip',
            pageLength: 6,
            lengthChange: false,
            buttons: [
                {
                    extend: 'colvis',
                    text: '<i class="fas fa-table"></i>',
                    className: 'btn btn-light'
                }
            ],
            stripeClasses: []
        });

        table.buttons().container().appendTo('#custom-buttons');

        $('#search-customer').on('keyup', function () {
            table.search(this.value).draw();
        });

      
    });
 // Open modal
    $(document).on('click', '.status-btn', function () {
        const helpId = $(this).data('id');
        $('#modal-help-id').val(helpId);
        $('#solution-text').val('');
        $('#solution-modal').fadeIn();
    });

    // Close modal
    $('#modal-close-btn').on('click', function () {
        $('#solution-modal').fadeOut();
    });

    // AJAX submit
    $('#solution-form').on('submit', function (e) {
        e.preventDefault();
        const helpId = $('#modal-help-id').val();
        const solution = $('#solution-text').val();

      if (!solution.trim()) {
    $('.toast-message').text("Please enter a remark...");
    $('#toast')
        .addClass('toast-show')
        .css('background-color', '#dc3545'); // red background for error
    setTimeout(() => $('#toast').removeClass('toast-show'), 3000);
    return;
}


        $.ajax({
            url: `/resolve-help/${helpId}/`,
            type: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                solution: solution
            },
            success: function (response) {
                if (response.success) {
                    $(`.status-btn[data-id="${helpId}"]`)
                        .removeClass('btn-warning status-btn')
                        .addClass('btn-secondary')
                        .text('Resolved')
                        .prop('disabled', true);

                    $('#solution-modal').fadeOut();
                    if (data.status === 'success') {
                        setTimeout(() => {
                        $('#toast').removeClass('toast-show');

                    }, 3000);
                }
            showToast("Issue resolved Successfully!");
                    location.reload();

                }
            },
            error: function () {
                alert('Error submitting solution.');
            }
                    
        });
    
    });

</script>


{% endblock %}
