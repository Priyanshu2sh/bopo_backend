{% extends "bopo_admin/base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'bopo_admin/css/reduce_limit.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<style>
    div.dataTables_filter { display: none !important; }

    .top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .search-box {
        padding: 6px 10px;
        width: 250px;
    }

    #custom-buttons-merchant,
    #custom-buttons-merchant-history {
        display: flex;
        justify-content: flex-end;
    }

    .dataTables_paginate {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .dataTables_paginate .paginate_button {
        background: linear-gradient(135deg, #ff7b54, #ff4e00);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(52, 49, 48, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
    }

    .dataTables_paginate .paginate_button:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #ff9a76, #ff6a2d);
        box-shadow: 0 6px 12px rgba(41, 39, 38, 0.4);
    }

    .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #333, #111);
        color: #fff;
        font-weight: bold;
        border: 2px solid #ff4e00;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.5);
    }
</style>

<div class="send-notification-container">
    <div class="send-notification-header">
        <h2>History</h2>
    </div>

    <!-- Transaction History -->
    <div class="send-notification-item">
        <input type="checkbox" id="toggle-transaction-history" class="toggle-checkbox">
        <label for="toggle-transaction-history" class="send-notification-label">
            <span class="send-notification-icon">üè¢</span>
            <span>Transaction History</span>
        </label>

        <div class="send-notification-form">
            <div class="customer-list">
                <div class="customer-table">
                    <div class="top-controls">
                        <input type="text" class="search-box" id="search-merchant">
                        <div id="custom-buttons-merchant"></div>
                    </div>

                    <table id="merchant-table" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Sr.No.</th>
                                <th>Customer</th>
                                <th>Merchant</th>
                                <th>Points</th>
                                <th>Type</th>
                                <th>Date & Time</th>
                            </tr>

                        </thead>
                     <tbody>
                        {% for history in history_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ history.customer.customer_id }}</td>
                            <td>{{ history.merchant.merchant_id }}</td>
                            <td>{{ history.points }}</td>
                            <td>{{ history.get_transaction_type_display }}</td>
                            <td>{{ history.created_at|date:"Y-m-d" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6">No transaction history available.</td></tr>
                        {% endfor %}
                    </tbody>

                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Out History -->
    <div class="send-notification-item">
        <input type="checkbox" id="toggle-cashout-history" class="toggle-checkbox">
        <label for="toggle-cashout-history" class="send-notification-label">
            <span class="send-notification-icon">üè¶</span>
            <span>Cash Out History</span>
        </label>

        <div class="send-notification-form">
            <div class="customer-list">
                <div class="customer-table">
                    <div class="top-controls">
                        <input type="text" class="search-box" id="search-merchant-history" placeholder="Search Merchant...">
                        <div id="custom-buttons-merchant-history"></div>
                    </div>

             <table id="merchant-table-history" class="display" style="width:100%">
    <thead>
        <tr>
            <th>#</th>
            <th>Merchant ID</th>
            <th>Contact Person</th>
            <th>Mobile Number</th>
            <th>Requested Amount (BBP)</th>
            <th>Payment Method</th>
        </tr>
    </thead>
 <tbody>
    {% for cash_out in merchant_cash_outs %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ cash_out.merchant.merchant_id }}</td>
      <td>{{ cash_out.merchant.first_name }} {{ cash_out.merchant.last_name }}</td>
      <td>{{ cash_out.merchant.mobile }}</td>
      <td>{{ cash_out.amount }}</td>
     <td>
  {% for payment in cash_out.superadminpayment_set.all %}
    {{ payment.payment_method }} ({{ payment.transaction_id }})<br>
  {% empty %}
    No payments
  {% endfor %}
</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<script>
    $(document).ready(function () {
        const merchantTable = $('#merchant-table').DataTable({
            dom: 'Bfrtip',
            pageLength: 6,
            lengthChange: false,
            buttons: [
                {
                    extend: 'colvis',
                    text: '<i class="fas fa-table"></i>',
                    className: 'btn btn-light'
                }
            ],
            stripeClasses: []
        });

        merchantTable.buttons().container().appendTo('#custom-buttons-merchant');

        $('#search-merchant').on('keyup', function () {
            merchantTable.search(this.value).draw();
        });

        const merchantHistoryTable = $('#merchant-table-history').DataTable({
            dom: 'Bfrtip',
            pageLength: 6,
            lengthChange: false,
            buttons: [
                {
                    extend: 'colvis',
                    text: '<i class="fas fa-table"></i>',
                    className: 'btn btn-light'
                }
            ],
            stripeClasses: []
        });

        merchantHistoryTable.buttons().container().appendTo('#custom-buttons-merchant-history');

        $('#search-merchant-history').on('keyup', function () {
            merchantHistoryTable.search(this.value).draw();
        });

        $('.open-merchant-modal-btn').click(function () {
            const id = $(this).data('id');
            openMerchantCashOutModal(id);
        });
    });

    // Show only one section at a time
   document.addEventListener("DOMContentLoaded", function () {
    const toggleCheckboxes = document.querySelectorAll(".toggle-checkbox");

    toggleCheckboxes.forEach((checkbox) => {
        const form = checkbox.closest(".send-notification-item").querySelector(".send-notification-form");
        form.style.display = checkbox.checked ? "block" : "none";

        checkbox.addEventListener("change", function () {
            toggleCheckboxes.forEach((otherCheckbox) => {
                const otherForm = otherCheckbox.closest(".send-notification-item").querySelector(".send-notification-form");

                if (otherCheckbox !== checkbox) {
                    otherForm.style.display = "none";
                    otherCheckbox.checked = false;
                }
            });

            // Toggle the clicked one
            form.style.display = checkbox.checked ? "block" : "none";
        });
    });
});

</script>

{% endblock %}
