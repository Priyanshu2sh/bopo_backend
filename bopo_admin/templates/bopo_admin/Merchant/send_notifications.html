{% extends "bopo_admin/base.html" %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/send_notifications.css' %}">

<div class="send-notification-container">
    {% if message %}
    <div class="success-message">{{ message }}</div>
    {% endif %}

    <div class="send-notification-header">
        <h2>Send Notifications</h2>
    </div>

    <!-- To Single Merchant -->
    <form method="POST" action="{% url 'create_notification' %}">
        {% csrf_token %}
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-single" class="toggle-checkbox">
            <label for="toggle-single" class="send-notification-label">
                <span class="send-notification-icon">üè¢</span> To Single Corporate Merchant
            </label>
            <div class="send-notification-form">
                <input type="hidden" name="form_type" value="single">
                <div class="form-group">
                    <label>Select Project:</label>
                    <select id="single_project" name="project_id" onchange="fetchMerchants()">
                        <option value="">Select a project</option>
                        {% for corporate in corporates %}
                        <option value="{{ corporate.project_id }}">{{ corporate.project_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Merchant ID:</label>
                    <select id="select-merchant" name="merchant_id">
                        <option value="">-- Select a Merchant --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notification Type:</label>
                    <input type="text" name="notification_type" required>
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" name="notification_title" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" rows="4" required></textarea>
                </div>
                <div class="button-container">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="send-btn">Send Notification</button>
                </div>
            </div>
        </div>
    </form>

    <!-- To All Merchants -->
    <form method="POST" action="{% url 'create_notification' %}">
        {% csrf_token %}
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-all-corporate" class="toggle-checkbox">
            <label for="toggle-all-corporate" class="send-notification-label">
                <span class="send-notification-icon">üë•</span> To All Corporate Merchants in a Project
            </label>
            <div class="send-notification-form">
                <input type="hidden" name="form_type" value="all">
                <div class="form-group">
                    <label>Select Project:</label>
                    <select name="project_id" required>
                        <option value="">Select a project</option>
                        {% for corporate in corporates %}
                        <option value="{{ corporate.project_id }}">{{ corporate.project_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Notification Type:</label>
                    <input type="text" name="notification_type" required>
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" name="notification_title" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" rows="4" required></textarea>
                </div>
                <div class="button-container">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="send-btn">Send Notification</button>
                </div>
            </div>
        </div>
    </form>

    <!-- To Single Individual Merchant -->
    <form method="POST" action="{% url 'send_notifications' %}">
        {% csrf_token %}
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-individual" class="toggle-checkbox">
            <label for="toggle-individual" class="send-notification-label">
                <span class="send-notification-icon">üè¨</span> To Single Individual Merchant
            </label>
            <div class="send-notification-form">
                <input type="hidden" name="form_type" value="single_individual">
                <div class="form-group">
                    <label>Select Merchant ID:</label>
                    <select id="select-individual-merchant" name="merchant">
                        <option value="">-- Select a Merchant --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notification Type:</label>
                    <input type="text" name="notification_type" required>
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" name="notification_title" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" rows="4" required></textarea>
                </div>
                <div class="button-container">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="send-btn">Send Notification</button>
                </div>
            </div>
        </div>
    </form>

    <!-- To All Individual Merchants -->
    <form method="POST" action="{% url 'send_notifications' %}">
        {% csrf_token %}
        <div class="send-notification-item">
            <input type="checkbox" id="toggle-all-individual" class="toggle-checkbox">
            <label for="toggle-all-individual" class="send-notification-label">
                <span class="send-notification-icon">üë§</span> To All Individual Merchants
            </label>
            <div class="send-notification-form">
                <input type="hidden" name="form_type" value="all_individual">
                <div class="form-group">
                    <label>Notification Type:</label>
                    <input type="text" name="notification_type" required>
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" name="notification_title" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" rows="4" required></textarea>
                </div>
                <div class="button-container">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="send-btn">Send Notification</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function fetchMerchants() {
    const projectId = document.getElementById("single_project").value;
    const merchantDropdown = document.getElementById("select-merchant");
    merchantDropdown.innerHTML = '<option value="">Loading...</option>';

    if (projectId) {
        fetch(`/get-merchants/?project_id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                merchantDropdown.innerHTML = '<option value="">-- Select a Merchant --</option>';
                data.merchants.forEach(merchant => {
                    const fullName = `${merchant.first_name} ${merchant.last_name || ''}`.trim();
                    merchantDropdown.innerHTML += `<option value="${merchant.merchant_id}">${merchant.merchant_id} - ${fullName}</option>`;
                });
            })
            .catch(error => {
                console.error("Error fetching merchants:", error);
                merchantDropdown.innerHTML = '<option value="">Error loading merchants</option>';
            });
    }
}

function fetchIndividualMerchants() {
    const merchantDropdown = document.getElementById("select-individual-merchant");
    merchantDropdown.innerHTML = '<option value="">Loading...</option>';

    fetch('/get-individual-merchants/')
        .then(response => response.json())
        .then(data => {
            merchantDropdown.innerHTML = '<option value="">-- Select a Merchant --</option>';
            data.merchants.forEach(merchant => {
                const fullName = `${merchant.first_name} ${merchant.last_name || ''}`.trim();
                merchantDropdown.innerHTML += `<option value="${merchant.merchant_id}">${merchant.merchant_id} - ${fullName}</option>`;
            });
        })
        .catch(error => {
            console.error("Error fetching individual merchants:", error);
            merchantDropdown.innerHTML = '<option value="">Error loading merchants</option>';
        });
}

document.addEventListener("DOMContentLoaded", () => {
    const toggles = [
        { id: "toggle-single", form: null, onShow: fetchMerchants },
        { id: "toggle-all-corporate", form: null },
        { id: "toggle-individual", form: null, onShow: fetchIndividualMerchants },
        { id: "toggle-all-individual", form: null }
    ];

    toggles.forEach(t => {
        const checkbox = document.getElementById(t.id);
        t.form = checkbox.closest(".send-notification-item").querySelector(".send-notification-form");
        t.form.style.display = "none";
        checkbox.addEventListener("change", () => {
            toggles.forEach(other => {
                const otherCheckbox = document.getElementById(other.id);
                if (otherCheckbox !== checkbox) {
                    otherCheckbox.checked = false;
                    other.form.style.display = "none";
                }
            });
            if (checkbox.checked) {
                t.form.style.display = "block";
                if (t.onShow) t.onShow();
            } else {
                t.form.style.display = "none";
            }
        });
    });
});
</script>
{% endblock %}
