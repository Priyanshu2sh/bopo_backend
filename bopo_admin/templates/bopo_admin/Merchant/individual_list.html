{% extends "bopo_admin/base.html" %}

{% block content %}
{% load static %}
{% load custom_filters %}

<link rel="stylesheet" href="{% static 'bopo_admin/css/individual_merchant_list.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="merchant-container">
    <div class="merchant-header">
        <button class="add-merchant-btn" onclick="window.location.href='{% url 'add_individual_merchant' %}'">
            + Add Merchant
        </button>
    </div>

    <div class="merchant-list">
        <div class="merchant-item">
            <input type="checkbox" id="toggle-individual" class="toggle-checkbox" checked>
            <label for="toggle-individual" class="merchant-label">
                <span class="merchant-icon">üë§</span>
                <span>Individual Merchants List</span>
            </label>
            <div class="merchant-table open">
                <input type="text" class="search-box" id="search-individual" onkeyup="filterTable()" placeholder="Search individual merchants...">
                <div class="table-wrapper">
                    <table id="individual-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Contact Person</th>
                                <th>Mobile Number</th>
                                <th>Shop Name</th>
                                <th>City</th>
                                <th>BBP</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="individual-table-body">
                            {% for merchant in merchants %}
                            <tr class="merchant-row">
                                <td>{{ forloop.counter }}</td>
                                <td>{{ merchant.first_name }} {{ merchant.last_name }}</td>
                                <td>{{ merchant.mobile }}</td>
                                <td>{{ merchant.shop_name }}</td>
                                <td>{{ merchant.city }}</td>
                                <td>{{ points_mapping|get_item:merchant.id }}</td>
                                <td>{{ merchant.verified_at|yesno:"Active,Inactive" }}</td>
                                <td>
                                    <button class="edit-btn" onclick="openEditModal('{{ merchant.id }}')">‚úèÔ∏è</button>
                                    <button class="delete-btn" onclick="deleteMerchant('{{ merchant.id }}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="pagination-controls" class="pagination-controls"></div>
                </div>
            </div>

            <!-- Edit Modal -->
            <div id="editModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditModal()">&times;</span>
                    <h3>Edit Merchant</h3>
                         <form id="editmerchantForm" method="POST">
                            {% csrf_token %}

                            {% if messages %}
                            {% for message in messages %}
                              <div style="color: green; font-weight: bold;">{{ message }}</div>
                            {% endfor %}
                            {% endif %}
                        <input type="hidden" name="merchant_id" id="edit_merchant_id">

                        <div class="add_individual_merchant-form-container">
                             <!-- Left Column -->
                               

                            <div class="add_individual_merchant-form-group">
                                <label>First Name</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-user"></i>
                                    <input type="text" name="first_name" id="edit_first_name" required>
                                </div>

                                <label>Email ID</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-envelope"></i>
                                    <input type="email" name="email" id="edit_email" required>
                                </div>

                                <label>Aadhaar Number</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-id-card"></i>
                                    <input type="text" name="aadhaar_number"  id="edit_aadhaar_number" pattern="\d{12}" maxlength="12" title="Enter a 12-digit Aadhaar number" required>
                                </div>

                                <label>Shop Name</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-store"></i>
                                    <input type="text" name="shop_name" id="edit_shop_name" required>
                                </div>

                                <label>Address</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <input type="text" name="address" id="edit_address" required>
                                </div>

                                <label>Select State</label>
                                <select id="edit_state" name="state" class="select2"  onchange="fetchCities()">
                                    <option value="">Select State</option>
                                </select>

                                <label>Country</label>
                                <div class="add_individual_merchant-input-container">
                                    <input type="text" name="country" value="India"  disabled>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="add_individual_merchant-form-group">
                                <label>Last Name</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-user"></i>
                                    <input type="text" name="last_name" id="edit_last_name"required>
                                </div>

                                <label>Mobile Number</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-mobile-alt"></i>
                                    <input type="text" name="mobile" id="edit_mobile" pattern="\d{10}" maxlength="10" title="Enter a 10-digit mobile number" required>
                                </div>

                                <label>GST Number</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-file-invoice"></i>
                                    <input type="text" name="gst" id="edit_gst" placeholder="Enter GST Number" pattern="^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$" title="Enter valid 15-character GSTIN (e.g., 27ABCDE1234F1Z5)" maxlength="15" required>
                                </div>
                                <div id="gst_error" style="display: none; margin-top: 10px;">
                                    <div style="background-color: #ffe6e6; border: 1px solid #ff4d4d; color: #d8000c; padding: 10px; border-radius: 5px; font-size: 14px; display: flex; align-items: center;">
                                        <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                                        Please enter a valid 15-character GSTIN (e.g., 27ABCDE1234F1Z5)
                                    </div>
                                </div>

                                <label>Pan Number</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-id-card"></i>
                                    <input type="text" name="pan_number" id="edit_pan" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" title="Enter valid PAN (e.g., ABCDE1234F)" required>
                                </div>

                                <label>Legal Name</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-building"></i>
                                    <input type="text" name="legal_name" id="edit_legal_name" required>
                                </div>

                                <label>Select City</label>
                                <select id="edit_city" name="city" class="select2">
                                    <option value="">Select City</option>
                                </select>

                                <label>Pincode</label>
                                <div class="add_individual_merchant-input-container">
                                    <i class="fas fa-home"></i>
                                    <input type="text" name="pincode" id="edit_pincode" pattern="\d{6}" maxlength="6" title="Enter a 6-digit pincode" required>
                                </div>
                            </div>
                          
                        </div>
                        <button type="submit" class="add_individual_merchant-btn-submit">Submit</button>
                    </div>  
                                    
                    </form>
                 </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Toast Notification -->
<div id="toast" class="toast-container {% if message %}toast-show{% endif %}">
    <i class="fa fa-exclamation-circle"></i>
    <span class="toast-message">{{ message }}</span>
</div>


<!-- Custom Confirmation Modal -->
<div id="confirmationModal" class="custom-modal">
    <div class="custom-modal-content">
      <h3 id="confirmationMessage">Are you sure you want to delete this merchant?</h3>
      <div class="custom-modal-buttons">
        <button id="confirmDelete" class="custom-btn">Yes</button>
        <button id="cancelDelete" class="custom-btn">No</button>
      </div>
    </div>
  </div>
  
  

<!-- JavaScript -->
<script>
function filterTable() {
    const filter = document.getElementById("search-individual").value.toLowerCase();
    const rows = document.querySelectorAll("#individual-table tbody tr");
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
}

document.addEventListener("DOMContentLoaded", function () {
    fetchStates();
    paginateTable();

    $('.select2').select2({
        placeholder: "Select an option",
        allowClear: true,
        width: '100%'
    });
});

    
document.getElementById("editmerchantForm").onsubmit = function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("/bopo_admin/update-merchant/", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken")  // Ensure the CSRF token is being sent
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || "Merchant updated successfully!");
            closeEditModal();
            setTimeout(() => {
                //location.reload();
            }, 1500); // Give user time to see the toast
        } else {
            showToast(data.message || "Something went wrong!");
        }
    })
    
    
    .catch(error => {
        console.error("Error:", error);
    });
};

function showToast(message, duration = 3000) {
    const toast = document.getElementById("toast");
    toast.querySelector(".toast-message").textContent = message;
    toast.classList.add("toast-show");

    setTimeout(() => {
        toast.classList.remove("toast-show");
    }, duration);
}

function getCookie(name) {
    const cookieName = `${name}=`;
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.indexOf(cookieName) === 0) {
            return cookie.substring(cookieName.length, cookie.length);
        }
    }
    return null;
}



function openEditModal(merchantId) {
    fetch(`/bopo_admin/edit-merchants/${merchantId}/`)


        .then(res => res.json())
        .then(data => {
            document.getElementById("edit_merchant_id").value = data.id;
            document.getElementById("edit_first_name").value = data.first_name;
            document.getElementById("edit_last_name").value = data.last_name;
            document.getElementById("edit_email").value = data.email;
            document.getElementById("edit_mobile").value = data.mobile;
            document.getElementById("edit_shop_name").value = data.shop_name;
            document.getElementById("edit_address").value = data.address;
            document.getElementById("edit_aadhaar_number").value = data.aadhaar_number;
            document.getElementById("edit_gst").value = data.gst;
            document.getElementById("edit_pan").value = data.pan_number;
            document.getElementById("edit_legal_name").value = data.legal_name;
            document.getElementById("edit_pincode").value = data.pincode;

            fetchStates().then(() => {
                const stateDropdown = document.getElementById("edit_state");
                stateDropdown.value = data.state;

                fetchCities(data.state).then(() => {
                    document.getElementById("edit_city").value = data.city;
                });
            });

            document.getElementById("editModal").style.display = "block";
        });
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}


function deleteMerchant(merchantId) {
    // Show the custom confirmation modal
    document.getElementById("confirmationModal").style.display = "flex";

    // Update the confirmation message dynamically if needed
    document.getElementById("confirmationMessage").textContent = "Are you sure you want to delete this merchant?";

    // When user clicks "Yes"
    document.getElementById("confirmDelete").onclick = function() {
        fetch(`/bopo_admin/delete-merchant/${merchantId}/`, {
            method: "DELETE",
            headers: {
                "X-CSRFToken": getCookie("csrftoken")  // Ensure the CSRF token is being sent
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast("Merchant deleted successfully!");
                // Optionally remove the row from the table or update the UI
                document.querySelector(`button[onclick="deleteMerchant('${merchantId}')"]`).closest("tr").remove();
            } else {
                showToast("Failed to delete merchant!");
            }
            // Hide the modal after action
            document.getElementById("confirmationModal").style.display = "none";
        })
        .catch(error => {
            console.error("Error deleting merchant:", error);
            showToast("Something went wrong!");
            // Hide the modal if there's an error
            document.getElementById("confirmationModal").style.display = "none";
        });
    };

    // When user clicks "No"
    document.getElementById("cancelDelete").onclick = function() {
        // Just close the modal without taking any action
        document.getElementById("confirmationModal").style.display = "none";
    };
}




function fetchStates() {
    return fetch("/bopo_admin/get-states/")
        .then(response => response.json())
        .then(states => {
            const stateDropdown = document.getElementById("edit_state");
            stateDropdown.innerHTML = '<option value="">Select State</option>';
            states.forEach(state => {
                let option = document.createElement("option");
                option.value = state.id;
                option.textContent = state.name;
                stateDropdown.appendChild(option);
            });
        });
}

function fetchCities(state) {
    const stateId = state || document.getElementById("edit_state").value;
    return fetch(`/bopo_admin/get-cities/${stateId}/`)
        .then(res => res.json())
        .then(cities => {
            const cityDropdown = document.getElementById("edit_city");
            cityDropdown.innerHTML = '<option value="">Select City</option>';
            cities.forEach(city => {
                let option = document.createElement("option");
                option.value = city.id;
                option.textContent = city.name;
                cityDropdown.appendChild(option);
            });
        });
}

const rowsPerPage = 5;
let currentPage = 1;

function paginateTable() {
    const table = document.getElementById("individual-table");
    const tbody = document.getElementById("individual-table-body");
    const rows = Array.from(tbody.getElementsByTagName("tr"));
    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const paginationDiv = document.getElementById("pagination-controls");

    // Hide all rows
    rows.forEach((row, index) => {
        row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
    });

    // Clear previous pagination
    paginationDiv.innerHTML = "";

    // Add new pagination buttons
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = i === currentPage ? "active-page" : "";
        btn.onclick = () => {
            currentPage = i;
            paginateTable();
        };
        paginationDiv.appendChild(btn);
    }
}

window.onload = paginateTable;





</script>
{% endblock %}
