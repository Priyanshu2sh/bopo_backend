{% extends "bopo_admin/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/terminals.css' %}">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="reduce-limit-back-btn">
  <a href="{% url 'individual_list' %}" class="reduce-limit-back-btn-submit">
    <i class="fa fa-arrow-left"></i> Back
  </a>
</div>

<div class="terminal-container">
  <h2>Terminals</h2>

  <div class="merchant-select-row">
    <label for="merchant_id">Select Merchant ID:</label>
    <select name="merchant_id" id="merchant_id" class="select2" style="width: 300px;">
        <option value="">-- Select Merchant --</option>
        {% for merchant in merchants %}
            <option value="{{ merchant.merchant_id }}">{{ merchant.merchant_id }}</option>
        {% endfor %}
    </select>

    <button id="add-terminal-btn" class="add-terminal-btn">
      Add Terminal
    </button>
  </div>

  <!-- Empty State -->
  <div id="empty-state" style="text-align: center; margin-top: 120px; margin-left: -80px; color: #888; width: 400px;">
    <i class="fa fa-database" style="font-size: 60px; margin-bottom: 10px;"></i>
    <p style="word-wrap: break-word; white-space: normal;">
      <i class="fa fa-exclamation-circle" style="font-size: 16px;"></i>
      No terminals found. Please select a merchant to see terminals.
    </p>
  </div>

  <!-- Terminal Table -->
  <div id="terminal-info">
    <table id="terminal-table" style="display: none; width: 100%; margin-top: 20px; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Terminal ID</th>
          <th>PIN</th>
          <th>Status</th>
          <th style="width: 50%;">Action</th>
        </tr>
      </thead>
      <tbody id="terminal-body"> 
        {% for terminal in terminals %}
        <tr>
            <td>{{ terminal.terminal_id }}</td>
            <td>
                <label class="switch">
                    <input type="checkbox" onchange="toggleStatus({{ terminal.id }}, this)" {% if terminal.status == 'Active' %}checked{% endif %}>
                    <span class="slider round"></span>

                    <span class="status-label {% if terminal.status == 'Active' %}text-success{% else %}text-danger{% endif %}" id="status-label-{{terminal.id }}"></span>
                </label>
            </td>
            <td>
                <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="{{ terminal.id }}">✏️ Edit</button>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Toggle status of terminal
  function toggleStatus(terminalId, checkboxElement) {
    fetch(`/toggle-terminal-status/${terminalId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            "is_active": checkboxElement.checked
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Failed to update status.');
            checkboxElement.checked = !checkboxElement.checked; // revert back
        } else {
            showToast('Terminal status updated successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkboxElement.checked = !checkboxElement.checked; // revert back
    });
  }

  // Show toast notifications
  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.classList.add('toast');
    toast.classList.add(type);
    toast.innerText = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('show');
    }, 100);

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }
$(document).ready(function() {
  // Initialize Select2 for the merchant_id dropdown
  $('#merchant_id').select2({
    placeholder: "Select Merchant",
    allowClear: true
  });

  // Handle merchant selection and display terminals
  $('#merchant_id').on('change', function() {
    var merchantId = $(this).val();

    if (merchantId) {
      fetch(`/get_terminals/${merchantId}/`)
        .then(response => response.json())
        .then(data => {
          var tableBody = document.getElementById('terminal-body');
          tableBody.innerHTML = '';

          if (data.terminals.length > 0) {
            data.terminals.forEach(function(terminal) {
              var row = document.createElement('tr');
              row.innerHTML = `
                <td>${terminal.terminal_id}</td>
                <td><input type="text" value="${terminal.tid_pin}" class="pin-input" readonly style="border: none; background: transparent; text-align: center;"></td>
                <td>${terminal.status}</td>
                <td>
                   <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="${terminal.terminal_id}">✏️ Edit</button>
                   <button class="btn btn-sm btn-success save-btn" data-terminal-id="${terminal.terminal_id}" style="display: none;">💾 Save</button>
                </td>
              `;
              tableBody.appendChild(row);
            });

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('terminal-table').style.display = 'table';
          } else {
            document.getElementById('terminal-table').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
          }
        });
    } else {
      document.getElementById('terminal-table').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
    }
  });

  // Handle Add Terminal button click
  $('#add-terminal-btn').click(function() {
    var merchantId = $('#merchant_id').val();

    if (merchantId) {
      fetch(`/add_terminal/${merchantId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({}),
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          var tableBody = document.getElementById('terminal-body');
          var row = document.createElement('tr');
          row.innerHTML = `
            <td>${data.terminal_id}</td>
            <td><input type="text" value="${data.tid_pin}" class="pin-input" readonly style="border: none; background: transparent; text-align: center;"></td>
            <td>${data.status}</td>
            <td>
              <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="${data.terminal_id}">✏️ Edit</button>
                <button class="btn btn-sm btn-success save-btn" data-terminal-id="${data.terminal_id}" style="display: none;">💾 Save</button>
              </div>
            </td>
          `;
          tableBody.appendChild(row);

          $('#empty-state').hide();
          $('#terminal-table').show();
        }
      });
    } else {
      alert('Please select a merchant first');
    }
  });

  // Handle Edit and Save button clicks
  $(document).on('click', '.edit-btn', function() {
    var row = $(this).closest('tr');
    var pinInput = row.find('.pin-input');
    var saveBtn = row.find('.save-btn');
    var editBtn = row.find('.edit-btn');

    pinInput.prop('readonly', false).css({'border': '1px solid #ccc', 'background': '#fff'}).focus();
    saveBtn.show();
    editBtn.hide();
  });

  $(document).on('click', '.save-btn', function() {
    var row = $(this).closest('tr');
    var pinInput = row.find('.pin-input');
    var terminalId = $(this).data('terminal-id');
    var merchantId = $('#merchant_id').val();
    var newPin = pinInput.val().trim();

    if (!newPin) {
      alert('PIN cannot be empty');
      return;
    }

    fetch(`/update_terminal_pin/${merchantId}/${terminalId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({ tid_pin: newPin })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('PIN updated successfully');

        pinInput.prop('readonly', true).css({'border': 'none', 'background': 'transparent'});
        saveBtn.hide();
        editBtn.show();
      } else {
        alert('Error updating PIN');
      }
    });
  });

  // Get CSRF Token from cookies
  function getCSRFToken() {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith('csrftoken=')) {
        cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
        break;
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
