{% extends "bopo_admin/base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/payment_details.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="payment_details-container">
    <div class="payment_details-back-to-list-btn">
        <a href="{% url 'employee_list' %}" class="send_credentials-add_individual_merchant-btn-submit">
            <i class="fa fa-arrow-left"></i> Back 
        </a>
    </div>

    <div class="payment_details-header">
        <h2>Top-Up Request</h2>
    </div>

    <div class="payment_details-list">
        <div class="payment_details-table">
            <input type="text" class="search-box" id="search-payment-details" onkeyup="filterTable('payment-table', 'search-payment-details')" placeholder="Search...">
            <table id="payment-table">
                <thead>
                    <tr>
                        <th>Sr.No.</th>
                        <th>Contact Person</th>
                        <th>Mobile Number</th>
                        <th>Paid Amount</th>
                        <th>Top-Up</th>
                        <th>Date</th>
                        <th>Payment Method</th>
                        <th>Plan Type</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in topups %}
                    <tr id="payment-row-{{ payment.id }}">
                        <td>{{ forloop.counter }}</td>

                        {% if payment.merchant %}
                            <td>{{ payment.merchant.first_name }} {{ payment.merchant.last_name }}</td>
                            <td>{{ payment.merchant.mobile }}</td>
                        {% elif payment.customer %}
                            <td>{{ payment.customer.first_name }} {{ payment.customer.last_name }}</td>
                            <td>{{ payment.customer.mobile }}</td>
                        {% else %}
                            <td colspan="2">Unknown</td>
                        {% endif %}

                        <td>{{ payment.paid_amount }}</td>
                        <td>{{ payment.topup_amount }}</td>
                        <td>{{ payment.created_at|date:"Y-m-d" }}</td>
                        <td>{{ payment.payment_mode }}</td>
                        <td>
                            {% if payment.merchant and payment.merchant.plan_type %}
                                {{ payment.merchant.plan_type|capfirst }}
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                        <td>
                            {% if payment.status == 'approved' %}
                                <button class="btn btn-sm btn-success" disabled>
                                    <i class="fas fa-check-circle"></i> Approved
                                </button>
                            {% elif payment.status == 'rejected' %}
                                <button class="btn btn-sm btn-danger" disabled>
                                    <i class="fas fa-times-circle"></i> Rejected
                                </button>
                            {% else %}
                                <button 
                                    id="approve-btn-{{ payment.id }}" 
                                    class="btn btn-sm btn-success" 
                                    onclick="showApproveModal('{{ payment.id }}', '{{ payment.plan_type }}')">
                                    <i class="fas fa-check-circle"></i> Approved
                                </button>
                                <button 
                                    id="reject-btn-{{ payment.id }}" 
                                    class="btn btn-sm btn-danger" 
                                    onclick="showRejectModal('{{ payment.id }}')">
                                    <i class="fas fa-times-circle"></i> Rejected
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9">No payment records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Modal for Approve Confirmation -->
<div id="approveModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="close" onclick="closeModal('approveModal')">&times;</span>
        <h3 id="confirmationMessage">Do you want to approve this payment?</h3>
        <div class="custom-modal-buttons">
            <button id="approveConfirmBtn" class="custom-btn green-btn">Yes, Approve</button>
            <button class="custom-btn red-btn" onclick="closeModal('approveModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Modal for Reject Confirmation -->
<div id="rejectModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="close" onclick="closeModal('rejectModal')">&times;</span>
        <h3 id="confirmationMessage">Do you want to reject this<br>payment?</h3>
        <div class="custom-modal-buttons">
            <button id="rejectConfirmBtn" class="custom-btn green-btn">Yes, Reject</button>
            <button class="custom-btn red-btn" onclick="closeModal('rejectModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Modal for Rental Plan Validity -->
<div id="rentalValidityModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="close" onclick="closeModal('rentalValidityModal')">&times;</span>
        <h3 id="confirmationMessage">Enter Rental Plan Validity<br> (in days):</h3>
        <input type="number" id="rentalValidityInput" min="1" placeholder="e.g. 30" class="validity-input" />
        <div class="custom-modal-buttons">
            <button id="rentalApproveConfirmBtn" class="custom-btn green-btn">Approve</button>
            <button class="custom-btn red-btn" onclick="closeModal('rentalValidityModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container">
    <i id="toast-icon" class=""></i>
    <span id="toast-message"></span>
</div>

<script>
    function showApproveModal(paymentId, planType) {
        if (planType === "rental") {
            document.getElementById("rentalValidityModal").style.display = "flex";
            document.getElementById("rentalApproveConfirmBtn").onclick = function () {
                let validity = document.getElementById("rentalValidityInput").value;
                if (!validity || parseInt(validity) <= 0) {
                    alert("Please enter a valid number of days.");
                    return;
                }
                approvePayment(paymentId, "rental", validity);
            };
        } else {
            document.getElementById('approveConfirmBtn').onclick = function () {
                approvePayment(paymentId, "prepaid");
            };
            document.getElementById('approveModal').style.display = "flex";
        }
    }

    function showRejectModal(paymentId) {
        document.getElementById('rejectConfirmBtn').onclick = function() {
            rejectPayment(paymentId);
        };
        document.getElementById('rejectModal').style.display = "flex";
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    function approvePayment(paymentId, planType, validity = null) {
        let bodyData = "payment_id=" + encodeURIComponent(paymentId) +
                       "&action=approve" +
                       (planType === "rental" ? "&validity=" + encodeURIComponent(validity) : "");

        fetch("{% url 'payment_details' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: bodyData
        })
        .then(response => response.json())
        .then(data => {
    if (data.success) {
        alert(data.message);
        // Disable approve button and hide reject button for this payment row
        const approveBtn = document.getElementById("approve-btn-" + paymentId);
        const rejectBtn = document.getElementById("reject-btn-" + paymentId);

        approveBtn.disabled = true;
        approveBtn.style.backgroundColor = "gray";
        approveBtn.style.borderColor = "gray";

        rejectBtn.style.display = "none";
    } else {
        alert("Error: " + data.message);
    }
})

        .catch(error => console.error("Error approving payment:", error));

        closeModal('approveModal');
        closeModal('rentalValidityModal');
    }

    function rejectPayment(paymentId) {
        fetch("{% url 'payment_details' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: "payment_id=" + encodeURIComponent(paymentId) + "&action=reject"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Disable approve button and hide reject button for this payment row
                document.getElementById("approve-btn-" + paymentId).disabled = true;
                document.getElementById("reject-btn-" + paymentId).style.display = "none";
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => console.error("Error rejecting payment:", error));

        closeModal('rejectModal');
    }

    function filterTable(tableId, searchBoxId) {
        let input = document.getElementById(searchBoxId);
        let filter = input.value.toLowerCase();
        let table = document.getElementById(tableId);
        let rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName("td");
            let rowMatch = false;

            for (let j = 0; j < cells.length; j++) {
                if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                    rowMatch = true;
                    break;
                }
            }
            rows[i].style.display = rowMatch ? "" : "none";
        }
    }

    // Helper function to get CSRF token cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>



{% endblock %}