{% extends "bopo_admin/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/terminals.css' %}">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="reduce-limit-back-btn">
  <a href="{% url 'individual_list' %}" class="reduce-limit-back-btn-submit">
    <i class="fa fa-arrow-left"></i> Back
  </a>
</div>

<div class="terminal-container">
  <h2>Terminals</h2>

  <div class="merchant-select-row">
    <label for="merchant_id">Select Merchant ID:</label>
    <select id="merchant_id" name="merchant_id" style="width: 900px;" class="select2">
      <option value="">--Select Merchant ID--</option>
      {% for merchant in merchants %}
        <option value="{{ merchant.merchant_id }}">{{ merchant.merchant_id }} - {{ merchant.first_name }} {{ merchant.last_name }}</option>
      {% endfor %}
    </select>

    <button id="add-terminal-btn" class="add-terminal-btn">
      Add Terminal
    </button>
  </div>

  <!-- Empty State -->
  <div id="empty-state" style="text-align: center; margin-top: 120px; margin-left: -80px; color: #888; width: 400px;">
    <i class="fa fa-database" style="font-size: 60px; margin-bottom: 10px;"></i>
    <p style="word-wrap: break-word; white-space: normal;">
      <i class="fa fa-exclamation-circle" style="font-size: 16px;"></i>
      No terminals found. Please select a merchant to see terminals.
    </p>
  </div>

  <!-- Terminal Table -->
  <div id="terminal-info">
    <table id="terminal-table" style="display: none; width: 100%; margin-top: 20px; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Terminal ID</th>
          <th>PIN</th>
          <th>Status</th>
          <th style="width: 50%;">Action</th>
        </tr>
      </thead>
      <tbody id="terminal-body">
        {% for terminal in terminals %}
          <tr>
            <td>{{ terminal.terminal_id }}</td>
            <td>
              <input type="text" value="{{ terminal.tid_pin }}" class="pin-input" readonly style="border: none; background: transparent; text-align: center;">
            </td>
            <td>
              <label class="switch">
                <input type="checkbox" onchange="toggleStatus('{{ terminal.terminal_id }}', this)" {% if terminal.status == 'Active' %}checked{% endif %}>
                <span class="slider round"></span>
              </label>
            </td>
            <td>
              <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="{{ terminal.terminal_id }}">‚úèÔ∏è Edit</button>
              <button class="btn btn-sm btn-success save-btn" data-terminal-id="{{ terminal.terminal_id }}" style="display: none;">üíæ Save</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  
document.addEventListener('DOMContentLoaded', function () {
    const toggles = document.querySelectorAll('.terminal-status-toggle');

    toggles.forEach(toggle => {
        toggle.addEventListener('change', function () {
            const terminalId = this.dataset.terminalId;
            const isChecked = this.checked;

            fetch(`/toggle-terminal-status/${terminalId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: isChecked })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Status updated successfully');
                } else {
                    alert('Failed to update status');
                }
            });
        });
    });
});

function toggleStatus(terminalId, checkbox) {
  const isActive = checkbox.checked;
  const csrfToken = '{{ csrf_token }}';

  fetch(`/toggle-terminal-status/${terminalId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({ is_active: isActive })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(`Status updated successfully to "${data.status}"`);
    } else {
      showToast("Failed to update status: " + (data.error || ""));
    }
  })
  .catch(() => {
    showToast('Error occurred while updating status', 'error');
  });
}

// Toast notification function
function showToast(message, type) {
  const toast = document.createElement('div');
  toast.classList.add('toast', type);

  let icon = '';
  if (type === 'success') {
    icon = '<i class="fa fa-check-circle" style="margin-right: 8px;"></i>';
  } else if (type === 'error') {
    icon = '<i class="fa fa-times-circle" style="margin-right: 8px;"></i>';
  } else if (type === 'warning') {
    icon = '<i class="fa fa-exclamation-triangle" style="margin-right: 8px;"></i>';
  } else {
    icon = '<i class="fa fa-info-circle" style="margin-right: 8px;"></i>';
  }

  toast.innerHTML = `${icon}${message}`;
  document.body.appendChild(toast);

  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

// Initialize Select2 and handle merchant selection change
$(document).ready(function() {
  $('#merchant_id').select2({
    placeholder: "Select Merchant ID",
    allowClear: true,
    width: 'resolve'
  });

  $('#merchant_id').on('change', function() {
    var merchantId = $(this).val();
    if (merchantId) {
      fetch(`/get_terminals/${merchantId}/`)
      .then(response => response.json())
      .then(data => {
        var tableBody = document.getElementById('terminal-body');
        tableBody.innerHTML = '';

        if (data.terminals.length > 0) {
          data.terminals.forEach(function(terminal) {
            var row = document.createElement('tr');
            row.innerHTML = `
              <td>${terminal.terminal_id}</td>
              <td><input type="text" value="${terminal.tid_pin}" class="pin-input" readonly style="border: none; background: transparent; text-align: center;"></td>
               <td>
        <label class="switch">
          <input type="checkbox" onchange="toggleStatus('${terminal.terminal_id}', this)" ${terminal.status === 'Active' ? 'checked' : ''}>
          <span class="slider round"></span>
        </label>
      </td>
              <td>
                <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="${terminal.terminal_id}">‚úèÔ∏è Edit</button>
                <button class="btn btn-sm btn-success save-btn" data-terminal-id="${terminal.terminal_id}" style="display: none;">üíæ Save</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          $('#empty-state').hide();
          $('#terminal-table').show();
        } else {
          $('#terminal-table').hide();
          $('#empty-state').show();
        }
      });
    } else {
      $('#terminal-table').hide();
      $('#empty-state').show();
    }
  });
});



// Add new terminal button click handler
document.getElementById('add-terminal-btn').addEventListener('click', function() {
  var merchantId = document.getElementById('merchant_id').value;
  if (merchantId) {
    fetch(`/add_terminal/${merchantId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showToast(data.error, 'error');
      } else {
        var row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.terminal_id}</td>
          <td><input type="text" value="${data.tid_pin}" class="pin-input" readonly style="border: none; background: transparent; text-align: center;"></td>
          <td>
            <label class="switch">
              <input type="checkbox" onchange="toggleStatus('${data.id}', this)" ${data.status === 'Active' ? 'checked' : ''}>
              <span class="slider round"></span>
            </label>
          </td>
          <td>
            <button class="btn btn-sm btn-warning edit-btn" data-terminal-id="${data.terminal_id}">‚úèÔ∏è Edit</button>
            <button class="btn btn-sm btn-success save-btn" data-terminal-id="${data.terminal_id}" style="display: none;">üíæ Save</button>
          </td>
        `;
        document.getElementById('terminal-body').appendChild(row);
        $('#empty-state').hide();
        $('#terminal-table').show();
        showToast('Terminal added successfully!', 'success');
        
      }
    });
  } else {
    showToast('Please select a merchant first.', 'warning');
  }
});

// Handle Edit and Save button clicks with event delegation
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('edit-btn')) {
    var row = event.target.closest('tr');
    var pinInput = row.querySelector('.pin-input');
    var saveBtn = row.querySelector('.save-btn');
    var editBtn = row.querySelector('.edit-btn');

    pinInput.removeAttribute('readonly');
    pinInput.style.border = '1px solid #ccc';
    pinInput.style.background = '#fff';
    pinInput.focus();

    saveBtn.style.display = 'inline-block';
    editBtn.style.display = 'none';
  }

  if (event.target.classList.contains('save-btn')) {
    var row = event.target.closest('tr');
    var pinInput = row.querySelector('.pin-input');
    var saveBtn = row.querySelector('.save-btn');
    var editBtn = row.querySelector('.edit-btn');

    var terminalId = event.target.getAttribute('data-terminal-id');
    var merchantId = document.getElementById('merchant_id').value;
    var newPin = pinInput.value.trim();

    if (!newPin) {
      showToast('PIN cannot be empty.', 'warning');
      return;
    }

    fetch(`/update_terminal_pin/${merchantId}/${terminalId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({ tid_pin: newPin })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        pinInput.setAttribute('readonly', 'readonly');
        pinInput.style.border = 'none';
        pinInput.style.background = 'transparent';
        saveBtn.style.display = 'none';
        editBtn.style.display = 'inline-block';
        showToast('PIN updated successfully.', 'success');
      } else {
        showToast('Error updating PIN.', 'error');
      }
    });
  }
});

// Utility to get CSRF token from cookies
function getCSRFToken() {
  let cookieValue = null;
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i].trim();
    if (cookie.startsWith('csrftoken=')) {
      cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
      break;
    }
  }
  return cookieValue;
}
</script>





{% endblock %}
