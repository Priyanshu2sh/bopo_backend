{% extends "bopo_admin/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'bopo_admin/css/account_info.css' %}">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">



<div class="payment_details-back-to-list-btn">
    <a href="{% url 'payment_details' %}" class="send_credentials-add_individual_merchant-btn-submit">
        <i class="fa fa-arrow-left"></i> Back 
    </a>
</div>

<h2 class="title">Bonus Point Account</h2>

<!-- Account Information Form -->
<form id="accountForm" method="POST" action="{% url 'account_info' %}">
    {% csrf_token %}
    <div class="container account-container mt-4">
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <div class="form-group">
                    <label>Account Number</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-university"></i></span>
                        <input type="text" name="accountNumber" class="form-control" id="accountNumber" value="{{ account.accountNumber|default:'' }}" placeholder="Enter Account Number" maxlength="18" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>Payable To</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" class="form-control" name="payableTo" id="payableTo" value="{{ account.payableTo|default:'' }}" placeholder="Enter Payable To" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>Bank Name</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                        <input type="text" class="form-control" name="bankName" id="bankName" value="{{ account.bankName|default:'' }}" placeholder="Enter Bank Name" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>City</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                        <input type="text" class="form-control" name="city" id="city" value="{{ account.city|default:'' }}" placeholder="Enter City" required>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <div class="form-group">
                    <label>Account Type</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-wallet"></i></span>
                        <input type="text" class="form-control" name="accountType" id="accountType" value="{{ account.accountType|default:'' }}" placeholder="Enter Account Type" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>IFSC Code</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                        <input type="text" class="form-control" name="ifscCode" id="ifscCode" value="{{ account.ifscCode|default:'' }}" placeholder="Enter IFSC Code" maxlength="11" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>Branch Name</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        <input type="text" class="form-control" name="branchName" id="branchName" value="{{ account.branchName|default:'' }}" placeholder="Enter Branch Name" required>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label>Pin Code</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                        <input type="text" class="form-control" name="pincode" id="pinCode" value="{{ account.pincode|default:'' }}" placeholder="Enter Pin Code" maxlength="6" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="button-container">
            <button type="button" class="btn btn-danger" id="cancelBtn" onclick="confirmCancel()"> <i class="fa fa-times-circle"></i> Cancel</button>
            <button type="submit" class="btn btn-success" id="saveBtn"><i class="fa fa-paper-plane"></i>  Submit</button>
        </div>
    </div>
</form>

<!-- Toast Notification -->
<div id="toast" class="toast-container">
    <i class="fa fa-check-circle"></i>
    <span class="toast-message">Account Created successfully!</span>
</div>

<!-- Custom Cancel Confirmation Modal -->
<div id="cancelConfirmationModal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-close-icon" id="closeCancelModal">&times;</span>
    <h3 id="cancelConfirmationMessage">Are you sure you want to cancel this action?</h3>
    <div class="custom-modal-buttons">
      <button id="confirmCancel" class="custom-btn cancel-yes">Yes</button>
      <button id="dismissCancel" class="custom-btn cancel-no">No</button>
    </div>
  </div>
</div>

<script>

    function showToast(message) {
    const toast = document.getElementById("toast");
    const toastMessage = toast.querySelector(".toast-message");

    toastMessage.textContent = message;
    toast.classList.add("toast-show");

    // Automatically hide toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove("toast-show");
    }, 3000);
}

    function confirmCancel() {
        // Select all input fields
        let inputs = document.querySelectorAll(".form-control");
        let emptyFields = false;

        // Check if any input field is empty
        inputs.forEach(input => {
            if (input.value.trim() === "") {
                emptyFields = true;
            }
        });

        // Show alert if fields are empty
        if (emptyFields) {
            alert("⚠️ Please fill in all fields before canceling.");
            return;
        }

        // Show confirmation dialog if all fields are filled
        let confirmAction = confirm("❗ Are you sure you want to cancel?");
        if (confirmAction) {
            window.location.href = "{% url 'home' %}"; // Redirect to Home Page
        }
    }

    document.getElementById("cancelBtn").addEventListener("click", function () {
        // Clear all input fields
        document.getElementById("accountForm").reset();
    });


const validators = {
    accountNumber: function(value) {
        if (value.trim() === "") return "Account Number is required";
        if (!/^\d+$/.test(value)) return "Account Number must contain only digits";
        if (value.length < 9 || value.length > 18)
        return "Account Number must be between 9 and 18 digits long";
        return "";
},

    payableTo: function(value) {
        if (value.trim() === "") return "Payable To is required";
        if (value.length < 3) return "Payable To must be at least 3 characters";
        return "";
    },
    bankName: function(value) {
        if (value.trim() === "") return "Bank Name is required";
        return "";
    },
    city: function(value) {
        if (value.trim() === "") return "City is required";
        return "";
    },
    accountType: function(value) {
        if (value.trim() === "") return "Account Type is required";
        return "";
    },
   ifscCode: function(value) {
       if (value === "") {
        return "Please enter your IFSC code.";
    }

    if (value.length !== 11) {
        return "IFSC code must be exactly 11 characters long.";
    }

    if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(value)) {
        return "Invalid IFSC format. It should look like: ABCD0XXXXXX";
    }
return "";
},  

    branchName: function(value) {
        if (value.trim() === "") return "Branch Name is required";
        return "";
    },
    pincode: function(value) {
        if (value.trim() === "") return "Pin Code is required";
        if (!/^\d{6}$/.test(value)) return "Pin Code must be 6 digits";
        return "";
    }
};



      // Live validation
    Object.keys(validators).forEach(name => {
        const input = document.getElementsByName(name)[0];
        if (!input) return;

        input.addEventListener("input", () => {
            const value = input.value.trim();
            const errorMessage = validators[name](value);
            input.setCustomValidity(errorMessage);
            input.reportValidity();
        });
    });



    document.getElementById("accountForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent normal form submission

         const form = this;
        let isValid = true;

        Object.keys(validators).forEach(name => {
            const input = document.getElementsByName(name)[0];
            const value = input.value.trim();
            const errorMessage = validators[name](value);
            input.setCustomValidity(errorMessage);
            if (errorMessage) {
                input.reportValidity();
                isValid = false;
            }
        });

        if (!isValid) return;

        let formData = new FormData(this);

        fetch("{% url 'account_info' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            showToast(data.message); // Show success toast
            setTimeout(() => {
                window.location.reload(); // Reload the page after 2 seconds
            }, 3000); // Adjust the time delay if needed
        } else {
            showToast(data.message || 'Error while saving'); // Show error toast
        }
    })
    .catch(error => {
        showToast('An error occurred');
        console.error("Error:", error);
    });
    });




function confirmCancel() {
    const modal = document.getElementById("cancelConfirmationModal");
    modal.style.display = "block";
}

document.addEventListener("DOMContentLoaded", function () {
    const dismissBtn = document.getElementById("dismissCancel");
    const confirmBtn = document.getElementById("confirmCancel");

    // Close the modal on clicking "No"
    dismissBtn.addEventListener("click", function () {
        document.getElementById("cancelConfirmationModal").style.display = "none";
    });

    // Redirect or perform cancel action on "Yes"
    confirmBtn.addEventListener("click", function () {
        window.location.href = "{% url 'home' %}";  // Redirect to terminals page
    });
});

document.getElementById("closeCancelModal").addEventListener("click", function () {
    document.getElementById("cancelConfirmationModal").style.display = "none";
});


    </script>
    

{% endblock %}
